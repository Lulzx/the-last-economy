<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ch 7 — The Generative Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300;1,400;1,500&family=DM+Sans:ital,opsz,wght@0,9..40,100..900;1,9..40,100..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body { background: #fafaf8; color: #1a1a1a; font-family: 'DM Sans', system-ui, sans-serif; margin: 0; }
.prose { max-width: 680px; margin: 0 auto; padding: 2rem 1.5rem; font-family: 'DM Sans', system-ui, sans-serif; line-height: 1.7; font-size: 1.05rem; }
.panel { background: white; border: 1px solid #e5e5e0; border-radius: 8px; padding: 1.5rem; margin: 2rem 0; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
.panel-spacer { height: 1rem; }
h1 { font-family: 'Playfair Display', Georgia, serif; font-size: clamp(1.8rem, 5vw, 2.6rem); font-weight: 700; margin-bottom: 0.5rem; }
h2 { font-family: 'Playfair Display', Georgia, serif; font-size: 1.3rem; font-weight: 600; margin-top: 2rem; }
.chapter-num { color: #888; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; }
#progress-bar { position: fixed; top: 0; left: 0; height: 3px; width: 0%; background: linear-gradient(90deg, #2563eb, #d97706); z-index: 1000; transition: width 0.1s linear; pointer-events: none; }
.nav { display: flex; justify-content: space-between; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e5e0; font-size: 0.9rem; position: sticky; top: 0; z-index: 100; background: rgba(250,250,248,0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
.nav a { color: #2563eb; text-decoration: none; }
svg text { font-family: 'DM Sans', system-ui, sans-serif; }

.btn { background: #2563eb; color: white; border: none; padding: 0.5rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin: 0.25rem; }
.btn:hover { background: #1d4ed8; }
.btn.secondary { background: #f5f5f3; color: #1a1a1a; border: 1px solid #e5e5e0; cursor: pointer; }
.btn.secondary:hover { background: #e5e5e0; }

.step-counter { font-size: 1rem; font-weight: 700; color: #2563eb; text-align: center; margin: 0.75rem 0; }
.noise-label { font-size: 0.9rem; color: #666; text-align: center; margin-bottom: 0.5rem; }

/* Denoiser grid */
#denoiser-svg { display: block; margin: 0 auto; width: 100%; max-width: 300px; height: auto; }

/* Economy mapping table */
.mapping-table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.9rem; }
.mapping-table th { background: #2563eb; color: white; padding: 0.5rem 0.75rem; text-align: left; font-weight: 600; }
.mapping-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid #e5e5e0; vertical-align: top; }
.mapping-table tr:last-child td { border-bottom: none; }
.mapping-table tr:nth-child(even) td { background: #f5f5f3; }

/* Gradient descent */
#landscape-svg { display: block; margin: 0 auto; cursor: crosshair; width: 100%; max-width: 600px; height: auto; }
.loss-display { text-align: center; font-size: 1.2rem; font-weight: 700; color: #2563eb; margin: 0.5rem 0; }
.loss-label { font-size: 0.85rem; color: #666; text-align: center; }

input[type=range] { accent-color: #2563eb; }

/* Enrichment styles */
.pullquote { border-left: 5px solid #2563eb; margin: 2rem 0; padding: 1rem 1.5rem; background: #eff6ff; border-radius: 0 8px 8px 0; box-shadow: 0 2px 8px rgba(37,99,235,0.08); }
.pullquote p { font-size: 1.15rem; font-style: italic; color: #1e40af; margin: 0; }
.pullquote .attribution { font-size: 0.85rem; font-style: normal; color: #555; margin-top: 0.5rem; }
.stat-callout { display: flex; flex-direction: column; align-items: center; padding: 1.5rem; background: white; border: 1px solid #e5e5e0; border-radius: 8px; margin: 1.5rem 0; text-align: center; }
.stat-number { font-family: 'Playfair Display', Georgia, serif; font-size: 3rem; font-weight: 700; color: #2563eb; line-height: 1; }
.stat-label { font-size: 0.9rem; color: #555; margin-top: 0.5rem; }
.section-divider { border: none; height: 1px; background: linear-gradient(90deg, transparent, #e5e5e0 20%, #e5e5e0 80%, transparent); margin: 3rem 0; }
.stat-row { display: flex; gap: 1rem; margin: 1.5rem 0; flex-wrap: wrap; }
.stat-row .stat-callout { flex: 1; min-width: 180px; margin: 0; }
.historical-mirror { background: #f9fafb; border: 1px solid #e5e5e0; border-radius: 8px; padding: 1.25rem 1.5rem; margin: 1.5rem 0; }
.historical-mirror .mirror-title { font-family: 'Playfair Display', Georgia, serif; font-size: 1rem; font-weight: 600; color: #1a1a1a; margin: 0 0 0.5rem 0; }
.historical-mirror p { margin: 0; font-size: 0.95rem; color: #444; }
.three-laws-grid { display: grid; grid-template-columns: 1fr; gap: 1.25rem; margin: 1.5rem 0; }
@media (min-width: 540px) { .three-laws-grid { grid-template-columns: repeat(3, 1fr); } }
.law-card { background: white; border: 1px solid #e5e5e0; border-radius: 8px; padding: 1.25rem; text-align: center; }
.law-card .law-icon { margin-bottom: 0.75rem; }
.law-card h3 { font-family: 'Playfair Display', Georgia, serif; font-size: 1rem; font-weight: 600; margin: 0 0 0.5rem 0; }
.law-card p { font-size: 0.88rem; color: #555; margin: 0; line-height: 1.5; }
.panel:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); transform: translateY(-1px); transition: all 0.2s ease; }
.panel { transition: all 0.2s ease; }
@media (max-width: 640px) {
  .panel-full { margin: 2rem 0; border-radius: 8px; border: 1px solid #e5e5e0; }
  .stat-row { flex-direction: column; }
}
</style>
</head>
<body>
<div id="progress-bar"></div>
<nav class="nav">
  <a href="04-maxwells-demon.html">&larr; Previous</a>
  <a href="explorables.html">All Chapters</a>
  <a href="05-mind-dashboard.html">Next &rarr;</a>
</nav>

<div class="prose">
  <div class="chapter-num">Chapter 7</div>
  <h1>The Generative Engine</h1>

  <div class="pullquote">
    <p>"Nature uses only the longest threads to weave her patterns, so each small piece of her fabric reveals the organization of the entire tapestry."</p>
    <div class="attribution">&mdash; Richard Feynman</div>
  </div>

  <h2>The Ghost in the Machine</h2>

  <p>We have now established the foundational principle of our new science. The universe, through the relentless filter of persistence, selects for systems that are efficient at reducing entropy. It favors intelligence. This is the "why."</p>

  <p>But we must now ask <em>how</em>. How does a universe of dumb, chaotic matter manage to organize itself into something as complex and predictive as a rainforest, a financial market, or a human brain? What is the algorithm that conjures order out of chaos?</p>

  <p>The answer is that nature has a universal method for creation. It is a process of guided, iterative refinement &mdash; a trick the cosmos has been using for thirteen point eight billion years. We did not invent this algorithm. We only just discovered it, gave it a fancy name, and taught it how to draw photorealistic astronauts riding horses.</p>

  <div class="stat-callout">
    <div class="stat-number">13.8 B</div>
    <div class="stat-label">Years the cosmos has been running its generative algorithm</div>
  </div>

  <hr class="section-divider">

  <h2>A Dispatch from the Digital Frontier</h2>

  <p>The process is called a <strong>diffusion model</strong>. It is the mathematical heart of AIs like Stable Diffusion and Midjourney, and it is a masterpiece of counterintuitive genius. It works in two steps.</p>

  <p>First, the <strong>Forward Process</strong>. You take a perfect, ordered thing &mdash; like a photograph of a cat &mdash; and you systematically destroy it. You add a tiny bit of random noise, then a little more, until all that remains is a featureless field of static. This is a perfect simulation of the Second Law of Thermodynamics: the universe's natural tendency to dissolve order into chaos.</p>

  <p>The magic is in the second step: the <strong>Reverse Process</strong>. The AI is trained to reverse this destruction. It learns how to start with pure, random noise and, step by tiny, intelligent step, remove that noise to reveal a coherent, ordered image. It is guided by a simple instruction &mdash; a "prompt." It constantly asks itself: <em>"Given this field of noisy pixels, what is the one, smallest change I can make that will move it infinitesimally closer to the concept I am trying to create?"</em></p>

  <div class="pullquote">
    <p>This is not just a clever trick for making pictures. This is the fundamental algorithm for creation.</p>
  </div>

  <!-- SVG illustration: Forward and Reverse Process -->
  <div class="panel" style="background: #f9fafb;">
    <svg viewBox="0 0 600 120" style="width:100%;display:block;" aria-label="Diffusion process: forward adds noise, reverse removes it">
      <!-- Forward arrow -->
      <text x="300" y="16" text-anchor="middle" font-size="12" fill="#888" font-weight="600">DIFFUSION PROCESS</text>
      <!-- Ordered state -->
      <rect x="30" y="35" width="70" height="70" rx="8" fill="#2563eb" opacity="0.9"/>
      <text x="65" y="74" text-anchor="middle" font-size="10" fill="white" font-weight="600">Order</text>
      <!-- Arrow forward -->
      <line x1="115" y1="70" x2="225" y2="70" stroke="#999" stroke-width="1.5" stroke-dasharray="4,3"/>
      <polygon points="225,65 235,70 225,75" fill="#999"/>
      <text x="175" y="60" text-anchor="middle" font-size="9" fill="#999">+ noise</text>
      <!-- Noisy state -->
      <rect x="250" y="35" width="70" height="70" rx="8" fill="#ccc" opacity="0.7"/>
      <circle cx="270" cy="60" r="3" fill="#aaa"/><circle cx="285" cy="55" r="2" fill="#bbb"/><circle cx="298" cy="75" r="4" fill="#999"/>
      <circle cx="275" cy="80" r="2" fill="#aaa"/><circle cx="290" cy="68" r="3" fill="#bbb"/><circle cx="305" cy="58" r="2" fill="#999"/>
      <text x="285" y="98" text-anchor="middle" font-size="9" fill="#777">Noise</text>
      <!-- Arrow reverse -->
      <line x1="335" y1="70" x2="465" y2="70" stroke="#2563eb" stroke-width="1.5"/>
      <polygon points="465,65 475,70 465,75" fill="#2563eb"/>
      <text x="400" y="60" text-anchor="middle" font-size="9" fill="#2563eb" font-weight="600">denoise (guided)</text>
      <!-- Recovered state -->
      <rect x="490" y="35" width="70" height="70" rx="8" fill="#2563eb" opacity="0.9"/>
      <text x="525" y="74" text-anchor="middle" font-size="10" fill="white" font-weight="600">Order</text>
      <!-- Labels -->
      <text x="65" y="118" text-anchor="middle" font-size="8" fill="#888">Forward Process</text>
      <text x="525" y="118" text-anchor="middle" font-size="8" fill="#888">Reverse Process</text>
    </svg>
  </div>

  <!-- Panel 1: The Denoising Process -->
  <div class="panel">
    <h2>The Denoising Process</h2>
    <p style="font-size:0.9rem;color:#666;margin-top:0">Watch pure noise resolve into a recognizable pattern, step by step &mdash; just as economies crystallize order from chaos.</p>
    <div class="noise-label" id="noise-label">Noise Level: 100% &mdash; Step 0 / 10</div>
    <svg id="denoiser-svg" viewBox="0 0 300 300"></svg>
    <div style="text-align:center;margin-top:1rem;display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;">
      <button class="btn" id="denoise-btn" onclick="runDenoise()">Denoise</button>
      <button class="btn secondary" onclick="resetDenoise()">Reset</button>
    </div>
    <div class="step-counter" id="step-counter"></div>
  </div>

  <div class="panel-spacer"></div>

  <hr class="section-divider">

  <h2>The Economy as a Generative Process</h2>

  <p>The economy is this process made manifest. It takes the chaotic "noise" of infinite human desires, resource constraints, and technological possibilities, and it generates coherent order: prices, firms, supply chains, and institutions.</p>

  <p>Every entrepreneur with a new idea, every consumer making a purchase, every investor placing a bet is participating in this vast, distributed computation. Each action is a small, incremental "denoising" step &mdash; an attempt to move the chaotic state of the present slightly closer to a more ordered, predictable future.</p>

  <div class="pullquote">
    <p>The economy is a Generative Engine &mdash; a machine for turning chaos into order, guided by the compass of intelligence.</p>
  </div>

  <p>The technical name for this process is <em>Stochastic Gradient Descent (SGD)</em> on a geometric manifold. But the intuition is now clear. The "prompt" guiding this entire process is the physical imperative: the drive to be an efficient engine of order.</p>

  <!-- Panel 2: Economy as Denoiser -->
  <div class="panel">
    <h2>Economy as Denoiser</h2>
    <p style="font-size:0.9rem;color:#666;margin-top:0">The diffusion model and the economy share the same architecture: both reverse entropy through iterated local decisions guided by a global objective.</p>
    <table class="mapping-table">
      <tr>
        <th>Diffusion Model</th>
        <th>Economy</th>
      </tr>
      <tr>
        <td><strong>Random noise</strong><br>Pure entropy, no structure</td>
        <td><strong>Infinite human desires &amp; constraints</strong><br>Competing needs, scarce resources, local knowledge</td>
      </tr>
      <tr>
        <td><strong>Denoising step</strong><br>Neural network removes a little noise</td>
        <td><strong>Market transaction / policy decision</strong><br>Local actors exchange value, reducing local uncertainty</td>
      </tr>
      <tr>
        <td><strong>Emergent pattern</strong><br>A recognizable image crystallizes</td>
        <td><strong>Prices, firms, supply chains</strong><br>Coherent order emerges from distributed decisions</td>
      </tr>
      <tr>
        <td><strong>The prompt</strong><br>The target image description</td>
        <td><strong>Drive to reduce entropy / create value</strong><br>The collective gradient that guides the system</td>
      </tr>
      <tr>
        <td><strong>Gradient descent</strong><br>The learning algorithm</td>
        <td><strong>Price signals</strong><br>Error signals that propagate through the network</td>
      </tr>
    </table>
  </div>

  <div class="panel-spacer"></div>

  <hr class="section-divider">

  <h2>The Manufacturer's Specification: Three Laws of a Living System</h2>

  <p>This generative process is not magic. It is a physical computation, and like all computations, it is subject to inviolable laws. For the economy's Generative Engine to function sustainably, it must obey three non-negotiable operating constraints. These are not assumptions &mdash; they are provable theorems that follow from Intelligence Theory. They are the manufacturer's specification for a reality that works.</p>

  <!-- SVG illustration: Three Laws Tripod -->
  <div style="text-align:center;margin:2rem 0;">
    <svg viewBox="0 0 400 260" style="width:100%;max-width:400px;" aria-label="Three Laws of a Living System forming a tripod of stability">
      <!-- Triangle connecting the three -->
      <polygon points="200,30 60,220 340,220" fill="none" stroke="#2563eb" stroke-width="2" stroke-dasharray="6,4" opacity="0.4"/>
      <!-- Center label -->
      <text x="200" y="150" text-anchor="middle" font-size="12" fill="#888" font-weight="600">LIVING SYSTEM</text>
      <!-- Flow -->
      <circle cx="200" cy="40" r="32" fill="#eff6ff" stroke="#2563eb" stroke-width="2"/>
      <text x="200" y="36" text-anchor="middle" font-size="20" fill="#2563eb">&#8635;</text>
      <text x="200" y="52" text-anchor="middle" font-size="8" fill="#1e40af" font-weight="600">FLOW</text>
      <!-- Openness -->
      <circle cx="60" cy="220" r="32" fill="#eff6ff" stroke="#2563eb" stroke-width="2"/>
      <text x="60" y="216" text-anchor="middle" font-size="20" fill="#2563eb">&#9673;</text>
      <text x="60" y="232" text-anchor="middle" font-size="8" fill="#1e40af" font-weight="600">OPENNESS</text>
      <!-- Resilience -->
      <circle cx="340" cy="220" r="32" fill="#eff6ff" stroke="#2563eb" stroke-width="2"/>
      <text x="340" y="216" text-anchor="middle" font-size="20" fill="#2563eb">&#9851;</text>
      <text x="340" y="232" text-anchor="middle" font-size="8" fill="#1e40af" font-weight="600">RESILIENCE</text>
    </svg>
  </div>

  <div class="three-laws-grid">
    <div class="law-card">
      <div class="law-icon">
        <svg width="48" height="48" viewBox="0 0 48 48"><circle cx="24" cy="24" r="20" fill="#eff6ff" stroke="#2563eb" stroke-width="2"/><path d="M16 24 C16 16 32 16 32 24 C32 32 16 32 16 24" fill="none" stroke="#2563eb" stroke-width="2.5" stroke-linecap="round"/><circle cx="24" cy="24" r="3" fill="#2563eb"/></svg>
      </div>
      <h3>1. The Law of Flow</h3>
      <p>Value must be conserved and circulated. Hoarded capital generates no new data and tests no new predictions. Flow is a physical necessity for intelligence.</p>
    </div>
    <div class="law-card">
      <div class="law-icon">
        <svg width="48" height="48" viewBox="0 0 48 48"><circle cx="24" cy="24" r="20" fill="#eff6ff" stroke="#2563eb" stroke-width="2"/><path d="M14 24h20M24 14v20" stroke="#2563eb" stroke-width="2.5" stroke-linecap="round"/><circle cx="14" cy="24" r="2" fill="#2563eb"/><circle cx="34" cy="24" r="2" fill="#2563eb"/><circle cx="24" cy="14" r="2" fill="#2563eb"/><circle cx="24" cy="34" r="2" fill="#2563eb"/></svg>
      </div>
      <h3>2. The Law of Openness</h3>
      <p>Connection fights entropy. A closed system will inevitably decay. Openness is not an ideological preference &mdash; it is a physical requirement for staving off systemic death.</p>
    </div>
    <div class="law-card">
      <div class="law-icon">
        <svg width="48" height="48" viewBox="0 0 48 48"><circle cx="24" cy="24" r="20" fill="#eff6ff" stroke="#2563eb" stroke-width="2"/><rect x="14" y="28" width="4" height="8" rx="1" fill="#2563eb" opacity="0.5"/><rect x="20" y="22" width="4" height="14" rx="1" fill="#2563eb" opacity="0.7"/><rect x="26" y="18" width="4" height="18" rx="1" fill="#2563eb" opacity="0.85"/><rect x="32" y="24" width="4" height="12" rx="1" fill="#2563eb" opacity="0.6"/></svg>
      </div>
      <h3>3. The Law of Resilience</h3>
      <p>Diversity creates stability. A monoculture is efficient but catastrophically fragile. Resilience through diversity is the only winning strategy against an unpredictable universe.</p>
    </div>
  </div>

  <!-- Historical Mirrors -->
  <h2>Historical Mirrors</h2>

  <div class="historical-mirror">
    <div class="mirror-title">The Collapse of Cahokia &mdash; When Flow Stops</div>
    <p>In 1250 CE, the city of Cahokia, near modern St. Louis, was larger than London &mdash; the heart of a continental network. For centuries, it thrived on flow. Then, around 1350, wealth began to concentrate. The flow constricted. Within a generation, Cahokia was abandoned. A grass-covered monument to what happens when circulation becomes accumulation.</p>
  </div>

  <div class="stat-row">
    <div class="stat-callout">
      <div class="stat-number">1250</div>
      <div class="stat-label">CE &mdash; Cahokia was larger than London</div>
    </div>
    <div class="stat-callout">
      <div class="stat-number">220</div>
      <div class="stat-label">Years Japan sealed itself from the world</div>
    </div>
  </div>

  <div class="historical-mirror">
    <div class="mirror-title">The Chained Country of Japan &mdash; The Price of Closure</div>
    <p>For two hundred and twenty years, from 1633 to 1853, Tokugawa Japan sealed itself from the world. The result was perfect stability and total technological stagnation. When Commodore Perry's black ships arrived with cannons, the Japanese were still fighting with swords. The ultimate lesson in the price of closure.</p>
  </div>

  <div class="historical-mirror">
    <div class="mirror-title">The Great Banana Collapse &mdash; The Cost of Monoculture</div>
    <p>For the first half of the 20th century, the entire global banana industry was a monoculture, optimized for a single variety: the Gros Michel. When a single, unpredicted soil fungus &mdash; Panama Disease &mdash; arrived, the entire system collapsed. The fungus was unstoppable. It stands as a stark lesson on the cost of sacrificing diversity for supply-chain efficiency.</p>
  </div>

  <hr class="section-divider">

  <h2>From Inference to Generation</h2>

  <p>This understanding of the economy as a generative engine proposes a fundamental shift in the scientific method of economics itself. For a century, economics has been a science of <em>inference</em> &mdash; deducing the workings of a complex system from sparse, aggregated, time-lagged data. It has been a science of reading shadows on a cave wall.</p>

  <p>Intelligent Economics is a science of <em>generation</em>. It is not about inferring a model from data; it is about defining the micro-physical laws of intelligent agents and then computing the emergent macro reality those laws generate. It replaces the econometrician's regression with the generative AI's simulation.</p>

  <div class="pullquote">
    <p>We no longer need to guess the rules of the game. We can, for the first time, build the game itself.</p>
  </div>

  <!-- Panel 3: The Gradient Descent Landscape -->
  <div class="panel">
    <h2>The Gradient Descent Landscape</h2>
    <p style="font-size:0.9rem;color:#666;margin-top:0">Click anywhere to place the ball, then click "Optimize" to watch gradient descent find the minimum &mdash; simulating how an economy (or an AI) rolls toward lower-entropy states.</p>
    <svg id="landscape-svg" viewBox="0 0 600 300"></svg>
    <div class="loss-label">Current Loss</div>
    <div class="loss-display" id="loss-display">&mdash;</div>
    <div style="text-align:center;margin-top:0.75rem;display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;">
      <button class="btn" id="optimize-btn" onclick="startOptimize()">Optimize</button>
      <button class="btn secondary" onclick="resetLandscape()">Reset</button>
    </div>
    <p style="font-size:0.85rem;color:#888;margin-top:0.75rem;text-align:center;">The landscape has multiple local minima — not all gradient descents reach the global optimum. Same problem for markets and AI alike.</p>
  </div>

  <hr class="section-divider">

  <p>The Three Laws &mdash; Flow, Openness, and Resilience &mdash; are not a moral checklist. They are the constitutional constraints, the manufacturer's specifications, for running a stable and successful simulation. This is the final meaning of a computable economy. With this new method in hand, we can now explore the architecture &mdash; the structures, capitals, and flows &mdash; that this generative process necessarily creates.</p>
</div>

<script>
// ========== Panel 1: Denoising Grid ==========
(function() {
  const GRID = 20;
  const CELL = 14;
  const PAD = 10;
  const svgSize = GRID * CELL + PAD * 2;

  // Target pattern: a simple house/smiley face encoded as values
  // 1 = colored, 0 = light (background)
  const target = [];
  for (let r = 0; r < GRID; r++) {
    target[r] = [];
    for (let c = 0; c < GRID; c++) {
      target[r][c] = 0;
    }
  }

  // Draw a simple house shape
  // Roof (triangle approximated as rows)
  for (let r = 2; r <= 8; r++) {
    const half = r - 2;
    const start = 10 - half;
    const end = 10 + half;
    for (let c = start; c <= end; c++) {
      if (c >= 0 && c < GRID) target[r][c] = 1;
    }
  }
  // Walls
  for (let r = 8; r <= 15; r++) {
    for (let c = 5; c <= 14; c++) {
      target[r][c] = 1;
    }
  }
  // Door
  for (let r = 11; r <= 15; r++) {
    for (let c = 8; c <= 11; c++) {
      target[r][c] = 0.3;
    }
  }
  // Windows
  for (let r = 9; r <= 11; r++) {
    for (let c = 6; c <= 7; c++) target[r][c] = 0.3;
    for (let c = 12; c <= 13; c++) target[r][c] = 0.3;
  }

  const svg = d3.select('#denoiser-svg')
    .attr('viewBox', `0 0 ${svgSize} ${svgSize}`);

  let noiseLevel = 1.0;
  let step = 0;
  const STEPS = 10;
  let animating = false;

  // Stable random values per cell (so noise doesn't flicker on re-render)
  const noise = [];
  function freshNoise() {
    for (let r = 0; r < GRID; r++) {
      noise[r] = [];
      for (let c = 0; c < GRID; c++) {
        noise[r][c] = Math.random();
      }
    }
  }
  freshNoise();

  const rects = svg.selectAll('rect')
    .data(d3.range(GRID * GRID))
    .join('rect')
    .attr('x', d => PAD + (d % GRID) * CELL)
    .attr('y', d => PAD + Math.floor(d / GRID) * CELL)
    .attr('width', CELL - 1)
    .attr('height', CELL - 1)
    .attr('rx', 1);

  function getColor(r, c, noiseVal) {
    const tgt = target[r][c];
    // Target color: blue for house walls, brown for door/windows, light background
    let targetColor;
    if (tgt === 1) targetColor = [37, 99, 235]; // #2563eb blue
    else if (tgt === 0.3) targetColor = [120, 80, 40]; // brown
    else targetColor = [240, 240, 238]; // background

    // Noise color: random gray
    const g = Math.floor(noise[r][c] * 200 + 30);
    const noiseColor = [g, g, g];

    // Blend between noise and target based on noise level
    const blend = noiseVal;
    const final = targetColor.map((t, i) => Math.round(t * (1 - blend) + noiseColor[i] * blend));
    return `rgb(${final[0]},${final[1]},${final[2]})`;
  }

  function renderGrid(nl) {
    rects.attr('fill', function(d) {
      const r = Math.floor(d / GRID);
      const c = d % GRID;
      return getColor(r, c, nl);
    });
  }

  window.resetDenoise = function() {
    noiseLevel = 1.0;
    step = 0;
    animating = false;
    freshNoise();
    document.getElementById('noise-label').textContent = 'Noise Level: 100% — Step 0 / 10';
    document.getElementById('step-counter').textContent = '';
    document.getElementById('denoise-btn').disabled = false;
    renderGrid(noiseLevel);
  };

  window.runDenoise = function() {
    if (animating || step >= STEPS) return;
    animating = true;
    document.getElementById('denoise-btn').disabled = true;

    function doStep() {
      if (step >= STEPS) {
        animating = false;
        document.getElementById('denoise-btn').disabled = false;
        return;
      }
      step++;
      noiseLevel = 1 - step / STEPS;
      // Re-seed noise slightly each step (some pixels "lock in")
      for (let r = 0; r < GRID; r++) {
        for (let c = 0; c < GRID; c++) {
          if (Math.random() < 0.3) noise[r][c] = Math.random();
        }
      }
      renderGrid(noiseLevel);
      const pct = Math.round(noiseLevel * 100);
      document.getElementById('noise-label').textContent = `Noise Level: ${pct}% — Step ${step} / ${STEPS}`;
      document.getElementById('step-counter').textContent = step < STEPS
        ? `Denoising... step ${step} of ${STEPS}`
        : 'Pattern fully resolved. Entropy reversed.';

      if (step < STEPS) {
        setTimeout(doStep, 450);
      } else {
        animating = false;
        document.getElementById('denoise-btn').disabled = false;
      }
    }
    doStep();
  };

  renderGrid(1.0);
})();

// ========== Panel 3: Gradient Descent Landscape ==========
(function() {
  const W = 600, H = 300;
  const svg = d3.select('#landscape-svg')
    .attr('viewBox', `0 0 ${W} ${H}`);

  // Loss function: multiple local minima
  function loss(x, y) {
    const nx = x / W, ny = y / H;
    // Multiple bowl minima
    const m1 = 3.5 * Math.exp(-((nx - 0.25) ** 2 + (ny - 0.7) ** 2) / 0.025);
    const m2 = 4.0 * Math.exp(-((nx - 0.75) ** 2 + (ny - 0.65) ** 2) / 0.018);
    const m3 = 5.0 * Math.exp(-((nx - 0.5) ** 2 + (ny - 0.3) ** 2) / 0.020);
    const base = 0.5 * Math.sin(nx * Math.PI * 2) * Math.sin(ny * Math.PI * 2.5);
    return 1 - (m1 + m2 + m3) / 5 + base * 0.15;
  }

  // Build heatmap using contours
  const NX = 60, NY = 30;
  const values = new Array(NX * NY);
  for (let j = 0; j < NY; j++) {
    for (let i = 0; i < NX; i++) {
      values[j * NX + i] = loss((i / NX) * W, (j / NY) * H);
    }
  }

  const contours = d3.contours().size([NX, NY]).thresholds(d3.range(0.05, 1.0, 0.08))(values);
  const xScale = d3.scaleLinear().domain([0, NX]).range([0, W]);
  const yScale = d3.scaleLinear().domain([0, NY]).range([0, H]);
  const path = d3.geoPath(d3.geoTransform({
    point: function(x, y) { this.stream.point(xScale(x), yScale(y)); }
  }));
  const colorScale = d3.scaleSequential(d3.interpolateRdYlGn).domain([1.0, 0.0]);

  svg.append('rect').attr('width', W).attr('height', H).attr('fill', '#fff8f0').attr('rx', 6);
  svg.selectAll('path.contour').data(contours).enter().append('path')
    .attr('d', path)
    .attr('fill', d => colorScale(d.value))
    .attr('stroke', 'rgba(0,0,0,0.08)')
    .attr('stroke-width', 0.5)
    .attr('opacity', 0.85);

  // Label minima
  const minima = [
    { x: W * 0.25, y: H * 0.7, label: 'Local min' },
    { x: W * 0.75, y: H * 0.65, label: 'Local min' },
    { x: W * 0.5, y: H * 0.3, label: 'Global min' }
  ];
  minima.forEach(m => {
    svg.append('circle').attr('cx', m.x).attr('cy', m.y).attr('r', 5)
      .attr('fill', 'none').attr('stroke', '#333').attr('stroke-width', 1.5);
    svg.append('text').attr('x', m.x).attr('y', m.y - 9)
      .attr('text-anchor', 'middle').attr('font-size', 9).attr('fill', '#555').text(m.label);
  });

  // Ball state
  let ballX = W * 0.7, ballY = H * 0.2;
  let optimizing = false;

  const trail = svg.append('g').attr('class', 'trail');
  const ball = svg.append('circle').attr('r', 9)
    .attr('fill', '#2563eb').attr('stroke', 'white').attr('stroke-width', 2.5)
    .attr('filter', 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))')
    .attr('cursor', 'grab');

  function updateBall() {
    ball.attr('cx', ballX).attr('cy', ballY);
    const l = loss(ballX, ballY);
    document.getElementById('loss-display').textContent = l.toFixed(3);
  }
  updateBall();

  // Click to place ball
  svg.on('click', function(event) {
    if (optimizing) return;
    const [mx, my] = d3.pointer(event);
    ballX = Math.max(10, Math.min(W - 10, mx));
    ballY = Math.max(10, Math.min(H - 10, my));
    trail.selectAll('*').remove();
    updateBall();
  });

  // Drag ball
  ball.call(d3.drag()
    .on('start', () => { if (!optimizing) ball.attr('cursor', 'grabbing'); })
    .on('drag', function(event) {
      if (optimizing) return;
      ballX = Math.max(10, Math.min(W - 10, event.x));
      ballY = Math.max(10, Math.min(H - 10, event.y));
      trail.selectAll('*').remove();
      updateBall();
    })
    .on('end', () => ball.attr('cursor', 'grab'))
  );

  window.startOptimize = function() {
    if (optimizing) return;
    optimizing = true;
    document.getElementById('optimize-btn').disabled = true;
    trail.selectAll('*').remove();

    const LR = 8; // learning rate (pixels)
    const ITERS = 80;
    let iter = 0;
    const EPS = 1.5;

    function step() {
      if (iter >= ITERS) {
        optimizing = false;
        document.getElementById('optimize-btn').disabled = false;
        return;
      }
      iter++;
      // Numerical gradient
      const l0 = loss(ballX, ballY);
      const gx = (loss(ballX + EPS, ballY) - l0) / EPS;
      const gy = (loss(ballX, ballY + EPS) - l0) / EPS;
      const mag = Math.sqrt(gx * gx + gy * gy) + 1e-6;
      const lr = LR * (1 - iter / ITERS * 0.7); // decaying LR

      // Add trail dot
      trail.append('circle')
        .attr('cx', ballX).attr('cy', ballY).attr('r', 2)
        .attr('fill', '#2563eb').attr('opacity', 0.3 + (iter / ITERS) * 0.3);

      ballX -= (gx / mag) * lr;
      ballY -= (gy / mag) * lr;
      ballX = Math.max(10, Math.min(W - 10, ballX));
      ballY = Math.max(10, Math.min(H - 10, ballY));
      updateBall();
      setTimeout(step, 40);
    }
    step();
  };

  window.resetLandscape = function() {
    optimizing = false;
    document.getElementById('optimize-btn').disabled = false;
    ballX = W * 0.7;
    ballY = H * 0.2;
    trail.selectAll('*').remove();
    updateBall();
  };
})();
</script>
<script>
window.addEventListener('scroll', function() {
  var p = document.documentElement;
  document.getElementById('progress-bar').style.width = (p.scrollTop / (p.scrollHeight - p.clientHeight) * 100) + '%';
});
</script>
</body>
</html>
