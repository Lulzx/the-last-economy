<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Harbingers of the Storm</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300;1,400;1,500&family=DM+Sans:ital,opsz,wght@0,9..40,100..900;1,9..40,100..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
/* ── Progress bar ── */
#progress-bar {
  position: fixed;
  top: 0;
  left: 0;
  height: 3px;
  width: 0%;
  background: linear-gradient(90deg, #2563eb, #d97706);
  z-index: 1000;
  transition: width 0.1s linear;
}

body { background: #fafaf8; color: #1a1a1a; font-family: 'DM Sans', system-ui, sans-serif; margin: 0; }
.prose { max-width: 680px; margin: 0 auto; padding: 2rem clamp(1rem, 4vw, 1.5rem); font-family: 'DM Sans', system-ui, sans-serif; line-height: 1.75; font-size: 1.05rem; }
.scrub { border-bottom: 2px dashed #2563eb; color: #2563eb; cursor: ew-resize; user-select: none; font-weight: 600; padding: 0 2px; }
.panel {
  background: white;
  border: 1px solid #e5e5e0;
  border-radius: 8px;
  padding: 1.5rem;
  margin: 2rem 0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  transition: box-shadow 0.2s, transform 0.2s;
}
.panel:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}
.panel-full {
  background: white;
  border-top: 1px solid #e5e5e0;
  border-bottom: 1px solid #e5e5e0;
  padding: 2rem;
  margin: 2rem -1.5rem;
}
h1 {
  font-family: 'Playfair Display', Georgia, serif;
  font-size: clamp(1.8rem, 5vw, 2.6rem);
  font-weight: 700;
  margin-bottom: 1rem;
  padding-bottom: 0.25rem;
}
h2 { font-family: 'Playfair Display', Georgia, serif; font-size: clamp(1.2rem, 3vw, 1.5rem); font-weight: 600; margin-top: 2rem; }
.chapter-num { color: #888; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; }

/* ── Sticky nav with backdrop blur ── */
.nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.85rem 1.5rem;
  border-bottom: 1px solid #e5e5e0;
  font-size: 0.9rem;
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(250, 250, 248, 0.88);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
.nav a { color: #2563eb; text-decoration: none; font-weight: 500; }
.nav a:hover { text-decoration: underline; }

svg text { font-family: 'DM Sans', system-ui, sans-serif; }
.bar-label { font-size: 11px; fill: #555; }
.info-box { font-size: 0.95rem; color: #333; margin-top: 1rem; min-height: 2rem; }
.decade-btn { padding: 0.35rem 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 0.85rem; margin: 0.2rem; transition: all 0.15s; }
.decade-btn:hover { border-color: #2563eb; color: #2563eb; }
.decade-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
.btn-row { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 1rem; }

/* Flickering */
.flicker-row { margin: 1.5rem 0; }
.flicker-label { font-size: 0.9rem; color: #888; margin-bottom: 0.35rem; }
.flicker-track { height: 40px; background: linear-gradient(90deg, #2563eb22 0%, #2563eb22 100%); border-radius: 20px; position: relative; overflow: hidden; }
.flicker-thumb { position: absolute; top: 4px; width: 32px; height: 32px; background: #2563eb; border-radius: 50%; cursor: ew-resize; transition: left 0.05s; }
.flicker-poles { display: flex; justify-content: space-between; font-size: 0.8rem; color: #555; margin-top: 0.25rem; }
.flicker-current { text-align: center; font-weight: 600; font-size: 1.1rem; min-height: 1.5rem; margin-top: 0.5rem; }
.shimmer { animation: shimmer 0.15s infinite alternate; }
@keyframes shimmer { from { opacity: 1; } to { opacity: 0.4; } }

/* Grid */
.grid-container { display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 4px; width: 100%; max-width: 100%; overflow-x: hidden; }
.grid-cell { width: 100%; aspect-ratio: 1; min-width: 0; border-radius: 6px; background: #e0e7ff; cursor: pointer; transition: background 0.3s; border: 1px solid #c7d2fe; }
.grid-cell.shocked { background: #ef4444; border-color: #dc2626; }
.grid-cell.spread { background: #f97316; border-color: #ea580c; }
.year-toggle { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
.year-toggle button { padding: 0.4rem 1.2rem; border: 2px solid #ddd; background: white; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.95rem; }
.year-toggle button.active { border-color: #2563eb; background: #eff6ff; color: #2563eb; }

/* Gauges */
.gauges { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
.gauge { text-align: center; padding: 1rem; border-radius: 8px; border: 2px solid #e5e5e0; transition: border-color 0.3s; }
.gauge-name { font-size: 0.8rem; color: #888; margin-bottom: 0.3rem; }
.gauge-value { font-size: 1.1rem; font-weight: 700; }
.gauge.high .gauge-value { color: #d97706; }
.gauge.critical .gauge-value { color: #ef4444; }
.gauge.critical { border-color: #fca5a5; animation: pulse 2s ease-in-out infinite; }
.dashboard-warning { text-align: center; padding: 1rem; margin-top: 1rem; border: 2px solid #ef4444; border-radius: 8px; background: #fef2f2; color: #b91c1c; font-weight: 600; display: none; }
.dashboard-warning.visible { display: block; }

/* Range slider accent */
input[type=range] { accent-color: #2563eb; }

/* Pulse animation for critical gauges */
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }

/* Pulsing animation for tipping point circle */
@keyframes tipPulse {
  0%, 100% { r: 6; opacity: 1; }
  50% { r: 9; opacity: 0.5; }
}
.tip-pulse {
  animation: tipPulse 1.8s ease-in-out infinite;
}

/* Primary button */
.btn { background: #2563eb; color: white; border: none; border-radius: 6px; padding: 0.5rem 1.2rem; cursor: pointer; font-size: 0.95rem; }

/* ── Pullquote ── */
.pullquote {
  border-left: 5px solid #2563eb;
  margin: 2rem 0;
  padding: 1rem 1.75rem;
  background: #eff6ff;
  border-radius: 0 8px 8px 0;
}
.pullquote p { font-size: 1.15rem; font-style: italic; color: #1e40af; margin: 0; }
.stat-callout { display: flex; flex-direction: column; align-items: center; padding: 1.5rem; background: white; border: 1px solid #e5e5e0; border-radius: 8px; margin: 1.5rem 0; text-align: center; }
.stat-number { font-family: 'Playfair Display', Georgia, serif; font-size: clamp(1.8rem, 6vw, 3rem); font-weight: 700; color: #2563eb; line-height: 1; }
.stat-label { font-size: 0.9rem; color: #555; margin-top: 0.5rem; }
.section-divider { border: none; height: 1px; background: linear-gradient(90deg, transparent, #e5e5e0 20%, #e5e5e0 80%, transparent); margin: 3rem 0; }
.stat-row { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; }
.stat-row .stat-callout { flex: 1; min-width: 140px; }
.illustration { display: flex; justify-content: center; margin: 2rem 0; }
.epigraph { text-align: center; margin: 1.5rem 0 2.5rem; color: #555; font-size: 0.95rem; }
.epigraph em { font-style: italic; }

/* ── Mobile fixes ── */
@media (max-width: 640px) {
  .panel-full {
    margin: 2rem 0;
    border-radius: 8px;
    border: 1px solid #e5e5e0;
  }
  .calc-cols {
    flex-direction: column;
  }
  .stat-row {
    flex-direction: column;
  }
  .gauges {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>
<div id="progress-bar"></div>
<nav class="nav">
  <a href="01-intelligence-inversion.html">&larr; Previous</a>
  <a href="explorables.html">All Chapters</a>
  <a href="03-gdp-illusion.html">Next &rarr;</a>
</nav>

<div class="prose">
  <div class="chapter-num">Chapter 2</div>
  <h1>Harbingers of the Storm</h1>

  <div class="epigraph">
    <em>"It happens gradually, then suddenly."</em><br>
    &mdash; Ernest Hemingway, <em>The Sun Also Rises</em>
  </div>

  <!-- ═══ The Devil's Staircase ═══ -->
  <h2>The Devil's Staircase</h2>

  <p>On Thursday, October 24, 1929, Richard Whitney, vice president of the New York Stock Exchange, strode onto the trading floor like a Roman god. The market had wobbled that morning, a minor tremor in its ascent to permanent prosperity. Whitney, acting for a consortium of the world's most powerful banks, placed a series of ostentatiously high bids for key stocks, a gesture of immense confidence. The floor erupted in cheers. The crisis was averted.</p>

  <p>Five days later, on Black Tuesday, the market lost twelve percent of its value in a single day. By 1932, it had fallen eighty-nine percent. Whitney himself would end up in Sing Sing prison for embezzlement. The permanent prosperity lasted exactly five days.</p>

  <!-- SVG: Devil's staircase illustration -->
  <div class="illustration">
    <svg viewBox="0 0 400 160" width="400" height="160" role="img" aria-label="A staircase pattern showing gradual rise followed by sudden collapse, representing how systems fail" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="stairGrad" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%" stop-color="#93c5fd"/>
          <stop offset="70%" stop-color="#2563eb"/>
          <stop offset="100%" stop-color="#ef4444"/>
        </linearGradient>
        <!-- Area fill gradient: light blue fading to transparent at bottom -->
        <linearGradient id="areaFill" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#93c5fd" stop-opacity="0.25"/>
          <stop offset="100%" stop-color="#93c5fd" stop-opacity="0"/>
        </linearGradient>
        <!-- Danger zone gradient -->
        <linearGradient id="dangerGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#ef4444" stop-opacity="0.12"/>
          <stop offset="100%" stop-color="#ef4444" stop-opacity="0.04"/>
        </linearGradient>
      </defs>

      <!-- Background -->
      <rect x="0" y="0" width="400" height="160" fill="#fafaf8"/>

      <!-- Subtle horizontal grid lines -->
      <line x1="20" y1="130" x2="380" y2="130" stroke="#e5e5e0" stroke-width="0.8"/>
      <line x1="20" y1="105" x2="380" y2="105" stroke="#e5e5e0" stroke-width="0.8"/>
      <line x1="20" y1="80" x2="380" y2="80" stroke="#e5e5e0" stroke-width="0.8"/>
      <line x1="20" y1="55" x2="380" y2="55" stroke="#e5e5e0" stroke-width="0.8"/>
      <line x1="20" y1="30" x2="380" y2="30" stroke="#e5e5e0" stroke-width="0.8"/>

      <!-- Danger zone shaded region near collapse -->
      <rect x="280" y="20" width="80" height="120" rx="4" fill="url(#dangerGrad)"/>
      <text x="320" y="18" font-size="8" fill="#ef4444" text-anchor="middle" font-family="'DM Sans', system-ui, sans-serif" font-weight="600">danger zone</text>

      <!-- Area under the staircase filled with gradient -->
      <path d="M 30 130 L 80 130 L 80 110 L 130 110 L 130 90 L 180 90 L 180 65 L 230 65 L 230 40 L 280 40 L 280 25 L 310 25 L 340 130 Z" fill="url(#areaFill)"/>

      <!-- Staircase path with gradient stroke -->
      <path d="M 30 130 L 80 130 L 80 110 L 130 110 L 130 90 L 180 90 L 180 65 L 230 65 L 230 40 L 280 40 L 280 25 L 310 25 L 340 130" fill="none" stroke="url(#stairGrad)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>

      <!-- Tipping point circle with pulse animation -->
      <circle cx="310" cy="25" r="6" fill="#ef4444" class="tip-pulse"/>
      <!-- Outer ring for pulse effect (static, semi-transparent) -->
      <circle cx="310" cy="25" r="10" fill="none" stroke="#ef4444" stroke-width="1" opacity="0.35"/>

      <text x="316" y="21" font-size="9" fill="#ef4444" font-weight="600" font-family="'DM Sans', system-ui, sans-serif">Tipping point</text>

      <!-- Labels with small arrows -->
      <text x="58" y="150" font-size="9" fill="#555" font-family="'DM Sans', system-ui, sans-serif">Gradual buildup &#8594;</text>
      <text x="270" y="150" font-size="9" fill="#ef4444" font-family="'DM Sans', system-ui, sans-serif">&#8592; Sudden collapse</text>
    </svg>
  </div>

  <p>The history books miss the most important lesson of that moment. Everyone saw the crash coming. Not the specific date, but the <em>wrongness</em>. The fevered speculation, the shoeshine boys giving stock tips, the pyramids of paper wealth built on foundations of vapor. They saw the signs, the harbingers of the storm, but they lacked the language to name them.</p>

  <p>We have that language now. It comes not from economics, but from physics, from the study of complex systems approaching a critical transition. An economy, like water about to boil, a forest about to catch fire, or tectonic plates about to slip, displays specific, measurable behaviors as it approaches a phase transition. These are not warnings. They are physical laws in motion.</p>

  <blockquote class="pullquote">
    <p>"Right now, every single one of these harbingers is screaming."</p>
  </blockquote>

  <p>Physics predicts phase transitions before they happen&mdash;through four warning signs: Critical Slowing Down, Variance Explosion, State Flickering, and Correlation Length growth. All four are active in our economy right now.</p>

  <hr class="section-divider">

  <!-- ═══ Harbinger #1: Critical Slowing Down ═══ -->
  <h2>Harbinger #1: Critical Slowing Down</h2>

  <p>Healthy systems are resilient. Push them, and they bounce back quickly. A healthy body fights off a cold in days. A healthy economy shrugs off a minor shock in a single quarter. This is the heartbeat of a living system: perturbation and recovery.</p>

  <p>But as a system approaches a critical transition, its recovery time lengthens. A push that once caused a wobble now causes a stagger. A stagger becomes a stumble. A stumble becomes a fall from which there is no recovery. Scientists call this "critical slowing down." The system loses its spring, its ability to self-correct.</p>

  <!-- SVG: Bouncing ball metaphor -->
  <div class="illustration">
    <svg viewBox="0 0 400 130" width="400" height="130" role="img" aria-label="Three balls bouncing with decreasing resilience, showing critical slowing down" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <!-- Radial gradients for 3D ball effect -->
        <radialGradient id="ballGreen" cx="35%" cy="30%" r="65%">
          <stop offset="0%" stop-color="#4ade80"/>
          <stop offset="100%" stop-color="#15803d"/>
        </radialGradient>
        <radialGradient id="ballAmber" cx="35%" cy="30%" r="65%">
          <stop offset="0%" stop-color="#fcd34d"/>
          <stop offset="100%" stop-color="#b45309"/>
        </radialGradient>
        <radialGradient id="ballRed" cx="35%" cy="30%" r="65%">
          <stop offset="0%" stop-color="#f87171"/>
          <stop offset="100%" stop-color="#b91c1c"/>
        </radialGradient>
      </defs>

      <!-- Background -->
      <rect x="0" y="0" width="400" height="130" fill="#fafaf8"/>

      <!-- Ground line, thicker with subtle fill below -->
      <line x1="10" y1="107" x2="390" y2="107" stroke="#d1d5db" stroke-width="2"/>
      <rect x="10" y="107" width="380" height="16" fill="#f3f4f6" rx="0"/>

      <!-- Healthy bounce -->
      <!-- Shadow ellipse on ground -->
      <ellipse cx="90" cy="108" rx="8" ry="2.5" fill="rgba(0,0,0,0.12)"/>
      <!-- Bounce path with envelope feel -->
      <path d="M 20 103 Q 40 28 60 103 Q 70 62 80 103 Q 85 78 90 103" fill="none" stroke="#16a34a" stroke-width="2" stroke-dasharray="none"/>
      <!-- Ball at rest -->
      <circle cx="90" cy="101" r="6" fill="url(#ballGreen)"/>
      <!-- Recovery time annotation -->
      <text x="55" y="122" font-size="9" fill="#16a34a" text-anchor="middle" font-family="'DM Sans', system-ui, sans-serif">Fast recovery</text>

      <!-- Label badge: Healthy -->
      <rect x="35" y="6" width="52" height="16" rx="8" fill="#dcfce7"/>
      <text x="61" y="18" font-size="9" fill="#16a34a" text-anchor="middle" font-weight="700" font-family="'DM Sans', system-ui, sans-serif">Healthy</text>

      <!-- Weakened bounce -->
      <ellipse cx="230" cy="108" rx="8" ry="2.5" fill="rgba(0,0,0,0.12)"/>
      <path d="M 160 103 Q 180 42 200 103 Q 215 73 230 103" fill="none" stroke="#d97706" stroke-width="2"/>
      <circle cx="230" cy="101" r="6" fill="url(#ballAmber)"/>
      <text x="200" y="122" font-size="9" fill="#d97706" text-anchor="middle" font-family="'DM Sans', system-ui, sans-serif">Slower recovery</text>

      <!-- Label badge: Weakened -->
      <rect x="168" y="6" width="64" height="16" rx="8" fill="#fef3c7"/>
      <text x="200" y="18" font-size="9" fill="#d97706" text-anchor="middle" font-weight="700" font-family="'DM Sans', system-ui, sans-serif">Weakened</text>

      <!-- Critical: no bounce -->
      <ellipse cx="380" cy="108" rx="8" ry="2.5" fill="rgba(0,0,0,0.12)"/>
      <path d="M 300 103 Q 320 52 340 103 L 380 103" fill="none" stroke="#ef4444" stroke-width="2"/>
      <circle cx="380" cy="101" r="6" fill="url(#ballRed)"/>
      <text x="350" y="122" font-size="9" fill="#ef4444" text-anchor="middle" font-family="'DM Sans', system-ui, sans-serif">No recovery</text>

      <!-- Label badge: Critical -->
      <rect x="322" y="6" width="56" height="16" rx="8" fill="#fee2e2"/>
      <text x="350" y="18" font-size="9" fill="#ef4444" text-anchor="middle" font-weight="700" font-family="'DM Sans', system-ui, sans-serif">Critical</text>
    </svg>
  </div>

  <div class="stat-row">
    <div class="stat-callout">
      <span class="stat-number">76</span>
      <span class="stat-label">Months to recover jobs after 2008</span>
    </div>
    <div class="stat-callout">
      <span class="stat-number">16</span>
      <span class="stat-label">Months to recover jobs after 1982</span>
    </div>
  </div>

  <p>We have been in a state of critical slowing down since 2008. When that crisis hit, Ben Bernanke, a scholar of the Great Depression, deployed every tool imaginable: zero interest rates, quantitative easing, forward guidance. The patient barely stirred. It took a full decade to achieve what previous recoveries accomplished in two years. The reflex was gone.</p>

  <blockquote class="pullquote">
    <p>"We are not bouncing back. We are being propped up. There is a profound difference."</p>
  </blockquote>

  <!-- Panel 1: Critical Slowing Down -->
  <div class="panel">
    <h2>Critical Slowing Down</h2>
    <p style="font-size:0.9rem;color:#666;margin-top:0">Months to recover pre-recession employment. Click a bar for details.</p>
    <div id="slowdown-chart" style="width:100%;max-width:620px;"></div>
    <div style="margin-top:1rem;">
      <div style="font-size:0.85rem;color:#888;margin-bottom:0.3rem;">System Resilience</div>
      <div id="resilience-meter" style="height:14px;background:#f1f1f1;border-radius:7px;overflow:hidden;">
        <div id="resilience-fill" style="height:100%;border-radius:7px;transition:width 0.4s;"></div>
      </div>
    </div>
    <div class="info-box" id="slowdown-info">Click a bar to learn more.</div>
  </div>

  <hr class="section-divider">

  <!-- ═══ Harbinger #2: Variance Explosion ═══ -->
  <h2>Harbinger #2: Variance Explosion</h2>

  <p>As a system approaches criticality, it does not just slow down. It becomes erratic. Small inputs create wildly disproportionate outputs. The technical term is "variance explosion," but you can think of it as the economic equivalent of a manic-depressive episode.</p>

  <p>These are the mood swings of a dying system. One day, markets soar three percent on a rumor of a central bank pivot. The next, they plunge four percent on the same rumor. This is not healthy volatility. This is a system that has lost its equilibrium mechanism&mdash;a thermostat that alternates between full heat and full blast AC, never finding the middle.</p>

  <!-- SVG: Widening oscillation -->
  <div class="illustration">
    <svg viewBox="0 0 400 128" width="400" height="128" role="img" aria-label="A sine wave with increasing amplitude, representing variance explosion" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="waveGrad" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%" stop-color="#93c5fd"/>
          <stop offset="60%" stop-color="#2563eb"/>
          <stop offset="100%" stop-color="#dc2626"/>
        </linearGradient>
        <linearGradient id="waveBg" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%" stop-color="#eff6ff" stop-opacity="0.4"/>
          <stop offset="100%" stop-color="#fef2f2" stop-opacity="0.4"/>
        </linearGradient>
        <marker id="waveArrow" markerWidth="6" markerHeight="4" refX="6" refY="2" orient="auto">
          <path d="M0,0 L6,2 L0,4" fill="#ccc"/>
        </marker>
      </defs>
      <!-- Background -->
      <rect x="0" y="0" width="400" height="128" rx="8" fill="#fafaf8"/>
      <!-- Gradient background zone showing widening -->
      <path d="M 20 60 L 380 15 L 380 105 Z" fill="url(#waveBg)" opacity="0.6"/>
      <!-- Subtle grid -->
      <line x1="20" y1="60" x2="380" y2="60" stroke="#e5e5e0" stroke-width="0.8" stroke-dasharray="3 3"/>
      <!-- Oscillation path -->
      <path d="M 20 60 Q 40 55 50 60 Q 60 65 70 60 Q 85 48 100 60 Q 115 72 130 60 Q 150 38 170 60 Q 190 82 210 60 Q 235 25 260 60 Q 285 95 310 60 Q 335 15 360 60 Q 370 80 380 60" fill="none" stroke="url(#waveGrad)" stroke-width="2.5" stroke-linecap="round"/>
      <!-- Amplitude indicators -->
      <line x1="50" y1="55" x2="50" y2="65" stroke="#93c5fd" stroke-width="1.5" stroke-dasharray="2"/>
      <line x1="260" y1="25" x2="260" y2="95" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="2"/>
      <text x="55" y="52" font-size="8.5" fill="#3b82f6" font-family="'DM Sans', system-ui, sans-serif">small</text>
      <text x="265" y="22" font-size="8.5" fill="#dc2626" font-family="'DM Sans', system-ui, sans-serif">extreme</text>
      <!-- Time arrow -->
      <line x1="20" y1="112" x2="380" y2="112" stroke="#ccc" stroke-width="1" marker-end="url(#waveArrow)"/>
      <text x="200" y="122" font-size="9" fill="#888" text-anchor="middle" font-family="'DM Sans', system-ui, sans-serif">Time →</text>
      <!-- Stability label -->
      <text x="60" y="9" font-size="8" fill="#3b82f6" text-anchor="middle" font-family="'DM Mono', monospace">Stable</text>
      <text x="330" y="9" font-size="8" fill="#dc2626" text-anchor="middle" font-family="'DM Mono', monospace">Critical</text>
    </svg>
  </div>

  <p>The meme stock frenzy of 2021 was not an aberration. It was a perfect harbinger. GameStop, a failing brick-and-mortar retailer, saw its stock price rocket from seventeen dollars to over four hundred dollars in two weeks&mdash;not because of any change in its business, but because a Reddit forum decided it would be amusing. This was not a story of David versus Goliath. It was a story about thermodynamics. A system with too much energy and too few productive outlets will find increasingly absurd ways to dissipate it.</p>

  <div class="stat-callout">
    <span class="stat-number">$17 &rarr; $400+</span>
    <span class="stat-label">GameStop's price swing in two weeks &mdash; variance made visible</span>
  </div>

  <blockquote class="pullquote">
    <p>"We do not have a housing bubble or a tech bubble. We have an Everything Bubble."</p>
  </blockquote>

  <!-- Panel 2: Variance Explosion -->
  <div class="panel">
    <h2>Variance Explosion</h2>
    <div class="btn-row" id="decade-btns"></div>
    <div id="variance-chart" style="width:100%;max-width:620px;"></div>
    <div class="info-box" id="variance-info"></div>
  </div>

  <hr class="section-divider">

  <!-- ═══ Harbinger #3: State Flickering ═══ -->
  <h2>Harbinger #3: Flickering Between States</h2>

  <p>Water about to freeze does something peculiar. At exactly zero degrees Celsius, you can see both ice crystals and liquid water coexisting, flickering back and forth. The substance cannot decide what state it wants to be in. This "flickering" is a universal signature of a system at a tipping point.</p>

  <!-- SVG: Phase transition flickering -->
  <div class="illustration">
    <svg viewBox="0 0 400 108" width="400" height="108" role="img" aria-label="Water molecules flickering between liquid and ice states near a phase transition" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="liquidFill" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#dbeafe"/>
          <stop offset="100%" stop-color="#bfdbfe"/>
        </linearGradient>
        <linearGradient id="iceFill" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#e0e7ff"/>
          <stop offset="100%" stop-color="#c7d2fe"/>
        </linearGradient>
        <filter id="flickShadow">
          <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.1"/>
        </filter>
        <marker id="arrowOrange" markerWidth="6" markerHeight="4" refX="6" refY="2" orient="auto">
          <path d="M0,0 L6,2 L0,4" fill="#d97706"/>
        </marker>
      </defs>
      <!-- Background -->
      <rect x="0" y="0" width="400" height="108" rx="8" fill="#fafaf8"/>
      <!-- Liquid state -->
      <rect x="12" y="22" width="110" height="65" rx="8" fill="url(#liquidFill)" stroke="#93c5fd" stroke-width="1.5" filter="url(#flickShadow)"/>
      <rect x="12" y="22" width="110" height="6" rx="8" fill="#3b82f6"/>
      <text x="67" y="17" font-size="9.5" fill="#2563eb" text-anchor="middle" font-weight="700" font-family="'DM Sans', system-ui, sans-serif">Liquid</text>
      <circle cx="38" cy="55" r="8" fill="#60a5fa" opacity="0.7"/>
      <circle cx="58" cy="46" r="6" fill="#60a5fa" opacity="0.6"/>
      <circle cx="80" cy="58" r="7" fill="#60a5fa" opacity="0.7"/>
      <circle cx="100" cy="49" r="5" fill="#60a5fa" opacity="0.5"/>
      <!-- Flickering zone (animated) -->
      <rect x="145" y="22" width="110" height="65" rx="8" fill="#fef3c7" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="5 3" filter="url(#flickShadow)">
        <animate attributeName="opacity" values="1;0.7;1" dur="1.2s" repeatCount="indefinite"/>
      </rect>
      <text x="200" y="17" font-size="9.5" fill="#d97706" text-anchor="middle" font-weight="700" font-family="'DM Sans', system-ui, sans-serif">Flickering ⟳</text>
      <circle cx="165" cy="49" r="7" fill="#60a5fa" opacity="0.5"/>
      <rect x="178" y="46" width="12" height="12" rx="2" fill="#a5b4fc" opacity="0.6"/>
      <circle cx="210" cy="56" r="6" fill="#60a5fa" opacity="0.4"/>
      <rect x="224" y="42" width="10" height="10" rx="2" fill="#a5b4fc" opacity="0.7"/>
      <!-- Ice state -->
      <rect x="278" y="22" width="110" height="65" rx="8" fill="url(#iceFill)" stroke="#a5b4fc" stroke-width="1.5" filter="url(#flickShadow)"/>
      <rect x="278" y="22" width="110" height="6" rx="8" fill="#6366f1"/>
      <text x="333" y="17" font-size="9.5" fill="#4f46e5" text-anchor="middle" font-weight="700" font-family="'DM Sans', system-ui, sans-serif">Ice</text>
      <rect x="294" y="38" width="14" height="14" rx="2" fill="#818cf8" opacity="0.7"/>
      <rect x="315" y="41" width="14" height="14" rx="2" fill="#818cf8" opacity="0.6"/>
      <rect x="336" y="38" width="14" height="14" rx="2" fill="#818cf8" opacity="0.7"/>
      <rect x="357" y="41" width="14" height="14" rx="2" fill="#818cf8" opacity="0.6"/>
      <rect x="305" y="57" width="14" height="14" rx="2" fill="#818cf8" opacity="0.5"/>
      <rect x="326" y="57" width="14" height="14" rx="2" fill="#818cf8" opacity="0.5"/>
      <!-- Arrows -->
      <path d="M 124 55 L 143 55" stroke="#d97706" stroke-width="1.5" fill="none" marker-end="url(#arrowOrange)"/>
      <path d="M 257 55 L 276 55" stroke="#d97706" stroke-width="1.5" fill="none" marker-end="url(#arrowOrange)"/>
      <!-- Bottom labels -->
      <text x="67" y="100" text-anchor="middle" font-size="8" fill="#3b82f6" font-family="'DM Mono', monospace">ordered</text>
      <text x="200" y="100" text-anchor="middle" font-size="8" fill="#d97706" font-family="'DM Mono', monospace">unstable</text>
      <text x="333" y="100" text-anchor="middle" font-size="8" fill="#6366f1" font-family="'DM Mono', monospace">crystallized</text>
    </svg>
  </div>

  <p>Our economy is flickering everywhere. The gig economy is purgatory. Are Uber drivers employees or independent contractors? After fifteen years and thousands of lawsuits, we still do not know. They are both and neither, flickering between states. They exist in a twilight zone with all the risks of entrepreneurship and none of the upside, all the control of employment and none of the security.</p>

  <p>Money itself flickers. Is Bitcoin a currency, a commodity, or a speculative asset? After fifteen years, we are still arguing. It flickers between these states, its identity shifting based on the narrative of the day. We are not evolving toward a new monetary system; we are stuck in the phase transition.</p>

  <!-- Panel 3: State Flickering -->
  <div class="panel">
    <h2>State Flickering</h2>
    <p style="font-size:0.9rem;color:#666;margin-top:0">Drag the indicators. Categories resist classification &mdash; a sign of criticality.</p>

    <div class="flicker-row">
      <div class="flicker-label">Uber Driver</div>
      <div class="flicker-track" id="flicker-uber">
        <div class="flicker-thumb" id="flicker-uber-thumb"></div>
      </div>
      <div class="flicker-poles"><span>Employee</span><span>Contractor</span></div>
      <div class="flicker-current" id="flicker-uber-label">Drag to classify</div>
    </div>

    <div class="flicker-row">
      <div class="flicker-label">Bitcoin</div>
      <div class="flicker-track" id="flicker-btc">
        <div class="flicker-thumb" id="flicker-btc-thumb"></div>
      </div>
      <div class="flicker-poles"><span>Currency</span><span>Asset</span><span>Security</span></div>
      <div class="flicker-current" id="flicker-btc-label">Drag to classify</div>
    </div>
  </div>

  <hr class="section-divider">

  <!-- ═══ Harbinger #4: Correlation Length Explosion ═══ -->
  <h2>Harbinger #4: Correlation Length Explosion</h2>

  <p>In a stable system, local events have local consequences. A bankruptcy in Buenos Aires does not affect a bakery in Baltimore. But as a system approaches criticality, everything becomes connected to everything else. The "correlation length"&mdash;the distance over which disturbances propagate&mdash;approaches infinity. The whole system becomes one giant, quivering, interconnected mass.</p>

  <!-- SVG: Local vs. global shock propagation -->
  <div class="illustration">
    <svg viewBox="0 0 400 138" width="400" height="138" role="img" aria-label="Comparison of shock propagation in 1980 (local) versus 2021 (global)" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <radialGradient id="localNode" cx="40%" cy="35%" r="60%">
          <stop offset="0%" stop-color="#c7d2fe"/>
          <stop offset="100%" stop-color="#e0e7ff"/>
        </radialGradient>
        <radialGradient id="shockedNode" cx="35%" cy="30%" r="65%">
          <stop offset="0%" stop-color="#f87171"/>
          <stop offset="100%" stop-color="#ef4444"/>
        </radialGradient>
        <radialGradient id="spreadNode" cx="35%" cy="30%" r="65%">
          <stop offset="0%" stop-color="#fb923c"/>
          <stop offset="100%" stop-color="#f97316"/>
        </radialGradient>
        <filter id="propShadow">
          <feDropShadow dx="0" dy="1" stdDeviation="2" flood-opacity="0.12"/>
        </filter>
      </defs>
      <!-- Background -->
      <rect x="0" y="0" width="400" height="138" rx="8" fill="#fafaf8"/>
      <!-- Section labels -->
      <rect x="10" y="6" width="178" height="18" rx="9" fill="#dcfce7"/>
      <text x="99" y="19" font-size="10" fill="#16a34a" text-anchor="middle" font-weight="700" font-family="'DM Sans', system-ui, sans-serif">1980: Local Shock</text>
      <rect x="212" y="6" width="178" height="18" rx="9" fill="#fee2e2"/>
      <text x="301" y="19" font-size="10" fill="#dc2626" text-anchor="middle" font-weight="700" font-family="'DM Sans', system-ui, sans-serif">2021: Global Cascade</text>
      <!-- 1980: local -->
      <circle cx="70" cy="57" r="10" fill="url(#localNode)" stroke="#a5b4fc" filter="url(#propShadow)"/>
      <circle cx="100" cy="37" r="10" fill="url(#localNode)" stroke="#a5b4fc" filter="url(#propShadow)"/>
      <circle cx="130" cy="57" r="10" fill="url(#localNode)" stroke="#a5b4fc" filter="url(#propShadow)"/>
      <circle cx="70" cy="87" r="10" fill="url(#localNode)" stroke="#a5b4fc" filter="url(#propShadow)"/>
      <circle cx="100" cy="67" r="10" fill="url(#shockedNode)" stroke="#dc2626" stroke-width="2" filter="url(#propShadow)"/>
      <circle cx="130" cy="87" r="10" fill="url(#localNode)" stroke="#a5b4fc" filter="url(#propShadow)"/>
      <circle cx="100" cy="97" r="10" fill="url(#spreadNode)" stroke="#ea580c" filter="url(#propShadow)"/>
      <line x1="70" y1="57" x2="100" y2="67" stroke="#d1d5db" stroke-width="1"/>
      <line x1="130" y1="57" x2="100" y2="67" stroke="#d1d5db" stroke-width="1"/>
      <line x1="100" y1="67" x2="100" y2="97" stroke="#fca5a5" stroke-width="2"/>
      <line x1="100" y1="37" x2="100" y2="67" stroke="#d1d5db" stroke-width="1"/>
      <text x="100" y="118" text-anchor="middle" font-size="8" fill="#16a34a" font-family="'DM Sans', system-ui, sans-serif">Contained</text>
      <!-- 2021: global -->
      <circle cx="270" cy="57" r="10" fill="url(#spreadNode)" stroke="#ea580c" filter="url(#propShadow)"/>
      <circle cx="300" cy="37" r="10" fill="url(#spreadNode)" stroke="#ea580c" filter="url(#propShadow)"/>
      <circle cx="330" cy="57" r="10" fill="url(#spreadNode)" stroke="#ea580c" filter="url(#propShadow)"/>
      <circle cx="270" cy="87" r="10" fill="url(#spreadNode)" stroke="#ea580c" filter="url(#propShadow)"/>
      <circle cx="300" cy="67" r="10" fill="url(#shockedNode)" stroke="#dc2626" stroke-width="2" filter="url(#propShadow)"/>
      <circle cx="330" cy="87" r="10" fill="url(#spreadNode)" stroke="#ea580c" filter="url(#propShadow)"/>
      <circle cx="300" cy="97" r="10" fill="url(#spreadNode)" stroke="#ea580c" filter="url(#propShadow)"/>
      <line x1="270" y1="57" x2="300" y2="67" stroke="#fca5a5" stroke-width="1.5"/>
      <line x1="330" y1="57" x2="300" y2="67" stroke="#fca5a5" stroke-width="1.5"/>
      <line x1="300" y1="67" x2="300" y2="97" stroke="#fca5a5" stroke-width="1.5"/>
      <line x1="300" y1="37" x2="300" y2="67" stroke="#fca5a5" stroke-width="1.5"/>
      <line x1="270" y1="87" x2="300" y2="97" stroke="#fca5a5" stroke-width="1.5"/>
      <line x1="330" y1="87" x2="300" y2="97" stroke="#fca5a5" stroke-width="1.5"/>
      <line x1="270" y1="57" x2="270" y2="87" stroke="#fca5a5" stroke-width="1.5"/>
      <line x1="330" y1="57" x2="330" y2="87" stroke="#fca5a5" stroke-width="1.5"/>
      <text x="300" y="118" text-anchor="middle" font-size="8" fill="#dc2626" font-family="'DM Sans', system-ui, sans-serif">Total cascade</text>
      <!-- Divider -->
      <line x1="200" y1="28" x2="200" y2="120" stroke="#e5e5e0" stroke-width="1" stroke-dasharray="4"/>
    </svg>
  </div>

  <p>In March 2021, a single container ship, the Ever Given, got stuck sideways in the Suez Canal. For six days, twelve percent of global trade stopped. This should have been a local problem for shippers. Instead, the effects cascaded globally. German car factories shut down for lack of parts. American furniture stores ran out of inventory. Brazilian coffee sat rotting on docks.</p>

  <div class="stat-row">
    <div class="stat-callout">
      <span class="stat-number">6</span>
      <span class="stat-label">Days the Suez Canal was blocked</span>
    </div>
    <div class="stat-callout">
      <span class="stat-number">12%</span>
      <span class="stat-label">Of global trade halted</span>
    </div>
  </div>

  <blockquote class="pullquote">
    <p>"There are no local problems anymore. A stuck ship in Egypt can crash the just-in-time dreams of the entire global economy."</p>
  </blockquote>

  <!-- Panel 4: Correlation Length -->
  <div class="panel">
    <h2>Correlation Length</h2>
    <div class="year-toggle">
      <button class="active" data-year="1980">1980</button>
      <button data-year="2021">2021</button>
    </div>
    <p style="font-size:0.9rem;color:#666;margin-top:0">Click a cell to shock it. Watch how far the disruption spreads.</p>
    <div style="max-width:100%;overflow-x:hidden;">
    <div class="grid-container" id="shock-grid"></div>
    </div>
    <div class="info-box" id="grid-info" style="margin-top:1rem;font-size:0.85rem;color:#888;">
      2021 Ever Given (Suez Canal): 6-day blockage, $60B/day global impact.
    </div>
  </div>

  <hr class="section-divider">

  <!-- ═══ The Grand Convergence ═══ -->
  <h2>The Grand Convergence</h2>

  <p>These are not four separate phenomena. They are four different scientific measurements of a single, underlying reality: a complex system that has reached criticality and is poised for a phase transition.</p>

  <div class="stat-row">
    <div class="stat-callout">
      <span class="stat-number" style="font-size:1.5rem;">Slow</span>
      <span class="stat-label">Interventions take years to work, if they work at all</span>
    </div>
    <div class="stat-callout">
      <span class="stat-number" style="font-size:1.5rem;">Wild</span>
      <span class="stat-label">Markets swing on sentiment, ignoring fundamentals</span>
    </div>
  </div>
  <div class="stat-row">
    <div class="stat-callout">
      <span class="stat-number" style="font-size:1.5rem;">Blurred</span>
      <span class="stat-label">Basic categories like "employee" or "money" cease to hold</span>
    </div>
    <div class="stat-callout">
      <span class="stat-number" style="font-size:1.5rem;">Total</span>
      <span class="stat-label">A single failure cascades globally in hours</span>
    </div>
  </div>

  <p>The terrifying beauty of this is that these harbingers are universal. They appear in ecosystems before they collapse, in stars before they go supernova, in societies before they have a revolution. They are not economic phenomena. They are physics. And physics does not care about your portfolio.</p>

  <!-- Panel 5: Combined Dashboard -->
  <div class="panel" id="dashboard-panel">
    <h2>Combined Dashboard</h2>
    <div class="gauges">
      <div class="gauge high"><div class="gauge-name">Critical Slowing Down</div><div class="gauge-value">HIGH</div></div>
      <div class="gauge high"><div class="gauge-name">Variance Explosion</div><div class="gauge-value">HIGH</div></div>
      <div class="gauge critical"><div class="gauge-name">State Flickering</div><div class="gauge-value">CRITICAL</div></div>
      <div class="gauge critical"><div class="gauge-name">Correlation Length</div><div class="gauge-value">CRITICAL</div></div>
    </div>
    <div class="dashboard-warning visible">System at criticality: 2 of 4 harbingers at CRITICAL</div>
  </div>

  <hr class="section-divider">

  <p>If you have been feeling that something is fundamentally wrong with the world but could not articulate what, now you can. It is not anxiety. It is pattern recognition. Your brain is processing these harbingers even if you lack the vocabulary. That feeling of deep, systemic <em>wrongness</em>? That is your limbic system screaming that the water is about to boil.</p>

  <p>The executives know it. The central bankers know it. They see these same signals. They just cannot say it out loud, because acknowledging the phase transition might be the very thing that triggers it. So they speak in code: "uncertainty," "volatility," "headwinds." Translation: the system is at a critical state, and we are out of moves.</p>

  <blockquote class="pullquote">
    <p>"Phase transitions are not endings. They are transformations. Water does not disappear when it boils; it becomes steam&mdash;a different state with different properties and new possibilities."</p>
  </blockquote>

  <p>The question is not whether the transition will happen. Physics has already decided that. The question is what we are transitioning <em>to</em>. And that is still up to us.</p>

</div>

<script>
// ── Reading progress bar ──
(function() {
  const bar = document.getElementById('progress-bar');
  function update() {
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const pct = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
    bar.style.width = pct + '%';
  }
  window.addEventListener('scroll', update, { passive: true });
  update();
})();

// ── Critical Slowing Down ──
(function() {
  const data = [
    { year: '1982', months: 16, desc: 'Volcker recession. Fed raised rates to 20% to break inflation. Recovery was sharp once rates dropped.' },
    { year: '1991', months: 23, desc: 'Savings & Loan crisis aftermath. Slower recovery signaled structural banking fragility.' },
    { year: '2001', months: 46, desc: 'Dot-com bust. "Jobless recovery" entered the lexicon. Offshoring accelerated.' },
    { year: '2008', months: 76, desc: 'Great Recession. 8.7M jobs lost. Recovery took 6+ years despite massive stimulus.' },
    { year: '2020', months: 29, desc: 'COVID crash. V-shaped recovery driven by $5T stimulus, but masked structural damage.' }
  ];
  const colorScale = d3.scaleLinear().domain([0, data.length - 1]).range(['#93c5fd', '#1e40af']);

  const container = document.getElementById('slowdown-chart');
  const w = 620, h = 200, m = { top: 10, right: 30, bottom: 25, left: 50 };
  const svg = d3.select('#slowdown-chart').append('svg')
    .attr('viewBox', `0 0 ${w} ${h}`).style('width', '100%');

  const x = d3.scaleLinear().domain([0, 80]).range([m.left, w - m.right]);
  const y = d3.scaleBand().domain(data.map(d => d.year)).range([m.top, h - m.bottom]).padding(0.3);

  svg.append('g').attr('transform', `translate(${m.left},0)`)
    .call(d3.axisLeft(y)).selectAll('text').style('font-size', '11px');
  svg.append('g').attr('transform', `translate(0,${h - m.bottom})`)
    .call(d3.axisBottom(x).ticks(5).tickFormat(d => d + ' mo')).selectAll('text').style('font-size', '10px');

  svg.selectAll('.bar').data(data).enter().append('rect')
    .attr('x', m.left).attr('y', d => y(d.year))
    .attr('width', d => x(d.months) - m.left).attr('height', y.bandwidth())
    .attr('fill', (d, i) => colorScale(i)).attr('rx', 3)
    .style('cursor', 'pointer')
    .on('click', function(e, d) {
      svg.selectAll('rect').attr('opacity', 0.4);
      d3.select(this).attr('opacity', 1);
      document.getElementById('slowdown-info').innerHTML = `<strong>${d.year}</strong> (${d.months} months): ${d.desc}`;
    });

  svg.selectAll('.bar-val').data(data).enter().append('text')
    .attr('x', d => x(d.months) + 5).attr('y', d => y(d.year) + y.bandwidth() / 2 + 4)
    .text(d => d.months + ' mo').style('font-size', '11px').style('fill', '#555');

  // Resilience meter — higher recovery months = lower resilience
  const trend = data.filter(d => d.year !== '2020');
  const avgRecovery = d3.mean(trend, d => d.months);
  const pct = Math.max(5, 100 - (avgRecovery / 80) * 100);
  const fill = document.getElementById('resilience-fill');
  fill.style.width = pct + '%';
  // Green at high resilience (high pct), red at low resilience (low pct)
  fill.style.background = pct < 40 ? '#ef4444' : pct < 60 ? '#d97706' : '#16a34a';
})();

// ── Variance Explosion ──
(function() {
  const decades = [
    { label: '1960s', val: 12 }, { label: '1970s', val: 18 }, { label: '1980s', val: 17 },
    { label: '1990s', val: 19 }, { label: '2000s', val: 22 }, { label: '2010s', val: 18 },
    { label: '2020s', val: 28 }
  ];

  const w = 620, h = 220, m = { top: 20, right: 20, bottom: 30, left: 45 };
  const svg = d3.select('#variance-chart').append('svg')
    .attr('viewBox', `0 0 ${w} ${h}`).style('width', '100%');

  const x = d3.scalePoint().domain(decades.map(d => d.label)).range([m.left, w - m.right]).padding(0.5);
  const y = d3.scaleLinear().domain([0, 35]).range([h - m.bottom, m.top]);

  svg.append('g').attr('transform', `translate(0,${h - m.bottom})`)
    .call(d3.axisBottom(x)).selectAll('text').style('font-size', '10px');
  svg.append('g').attr('transform', `translate(${m.left},0)`)
    .call(d3.axisLeft(y).ticks(5)).selectAll('text').style('font-size', '10px');

  svg.append('text').attr('transform', 'rotate(-90)').attr('x', -(h/2)).attr('y', 12)
    .attr('text-anchor', 'middle').style('font-size', '11px').style('fill', '#888').text('Avg Annual VIX');

  // Amplitude bands (hidden initially)
  const bands = svg.selectAll('.vband').data(decades).enter().append('rect')
    .attr('class', 'vband')
    .attr('x', d => x(d.label) - 25).attr('y', d => y(d.val))
    .attr('width', 50).attr('height', d => y(0) - y(d.val))
    .attr('fill', '#2563eb').attr('opacity', 0).attr('rx', 3);

  const line = d3.line().x(d => x(d.label)).y(d => y(d.val)).curve(d3.curveMonotoneX);
  svg.append('path').datum(decades).attr('d', line)
    .attr('fill', 'none').attr('stroke', '#2563eb').attr('stroke-width', 2.5);

  svg.selectAll('.dot').data(decades).enter().append('circle')
    .attr('cx', d => x(d.label)).attr('cy', d => y(d.val)).attr('r', 4)
    .attr('fill', '#2563eb');

  // 2020s annotation
  const last = decades[decades.length - 1];
  svg.append('text').attr('x', x(last.label)).attr('y', y(last.val) - 12)
    .attr('text-anchor', 'middle').style('font-size', '11px').style('fill', '#ef4444').style('font-weight', '600')
    .text('Unprecedented');
  svg.append('line')
    .attr('x1', x(last.label)).attr('y1', y(last.val) - 4)
    .attr('x2', x(last.label)).attr('y2', y(last.val) + 4)
    .attr('stroke', '#ef4444').attr('stroke-width', 1.5).attr('marker-end', '');

  // Buttons
  const btnRow = document.getElementById('decade-btns');
  decades.forEach((d, i) => {
    const btn = document.createElement('button');
    btn.className = 'decade-btn';
    btn.textContent = d.label;
    btn.onclick = () => {
      document.querySelectorAll('.decade-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      bands.transition().duration(200).attr('opacity', (_, j) => j === i ? 0.2 : 0);
      document.getElementById('variance-info').innerHTML =
        `<strong>${d.label}</strong>: Average VIX ~ ${d.val}` + (d.label === '2020s' ? ' &mdash; highest sustained volatility on record.' : '');
    };
    btnRow.appendChild(btn);
  });
})();

// ── State Flickering ──
(function() {
  function setupFlicker(trackId, thumbId, labelId, states) {
    const track = document.getElementById(trackId);
    const thumb = document.getElementById(thumbId);
    const label = document.getElementById(labelId);
    const trackW = track.offsetWidth || 300;
    let pct = 0.5;

    function render() {
      const left = Math.max(0, Math.min(1, pct)) * (trackW - 32);
      thumb.style.left = left + 'px';
      const idx = Math.min(states.length - 1, Math.floor(pct * states.length));
      const distFromCenter = states.length === 2
        ? Math.abs(pct - 0.5)
        : Math.min(...states.map((_, i) => Math.abs(pct - (i + 0.5) / states.length)));
      const isNearEdge = distFromCenter < 0.12;
      label.textContent = states[idx];
      if (isNearEdge) {
        label.classList.add('shimmer');
      } else {
        label.classList.remove('shimmer');
      }
    }

    let dragging = false;
    thumb.addEventListener('mousedown', e => { dragging = true; e.preventDefault(); });
    document.addEventListener('mousemove', e => {
      if (!dragging) return;
      const rect = track.getBoundingClientRect();
      pct = (e.clientX - rect.left) / rect.width;
      pct = Math.max(0, Math.min(1, pct));
      render();
    });
    document.addEventListener('mouseup', () => { dragging = false; });
    // Touch
    thumb.addEventListener('touchstart', e => { dragging = true; e.preventDefault(); });
    document.addEventListener('touchmove', e => {
      if (!dragging) return;
      const rect = track.getBoundingClientRect();
      pct = (e.touches[0].clientX - rect.left) / rect.width;
      pct = Math.max(0, Math.min(1, pct));
      render();
    });
    document.addEventListener('touchend', () => { dragging = false; });
    render();
  }

  // Delay to allow layout
  requestAnimationFrame(() => {
    setupFlicker('flicker-uber', 'flicker-uber-thumb', 'flicker-uber-label', ['Employee', 'Contractor']);
    setupFlicker('flicker-btc', 'flicker-btc-thumb', 'flicker-btc-label', ['Currency', 'Asset', 'Security']);
  });
})();

// ── Correlation Length ──
(function() {
  let currentYear = 1980;
  const gridEl = document.getElementById('shock-grid');
  const cells = [];

  // Build grid
  for (let i = 0; i < 36; i++) {
    const cell = document.createElement('div');
    cell.className = 'grid-cell';
    cell.dataset.idx = i;
    gridEl.appendChild(cell);
    cells.push(cell);
  }

  function resetGrid() {
    cells.forEach(c => { c.className = 'grid-cell'; });
  }

  function neighbors(idx) {
    const row = Math.floor(idx / 6), col = idx % 6;
    const n = [];
    if (row > 0) n.push(idx - 6);
    if (row < 5) n.push(idx + 6);
    if (col > 0) n.push(idx - 1);
    if (col < 5) n.push(idx + 1);
    return n;
  }

  function shock(idx) {
    resetGrid();
    cells[idx].classList.add('shocked');
    if (currentYear === 1980) {
      // Spread to 1-2 adjacent
      const adj = neighbors(idx);
      const spread = adj.slice(0, 1 + Math.floor(Math.random() * 2));
      spread.forEach((n, i) => {
        setTimeout(() => cells[n].classList.add('spread'), 200 + i * 150);
      });
    } else {
      // Cascade to entire grid
      const visited = new Set([idx]);
      let frontier = [idx];
      let delay = 0;
      function step() {
        delay += 120;
        const next = [];
        frontier.forEach(f => {
          neighbors(f).forEach(n => {
            if (!visited.has(n)) {
              visited.add(n);
              next.push(n);
              setTimeout(() => cells[n].classList.add('spread'), delay + Math.random() * 80);
            }
          });
        });
        frontier = next;
        if (frontier.length > 0) step();
      }
      step();
    }
  }

  cells.forEach((c, i) => c.addEventListener('click', () => shock(i)));

  document.querySelectorAll('.year-toggle button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.year-toggle button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentYear = parseInt(btn.dataset.year);
      resetGrid();
    });
  });
})();
</script>
</body>
</html>
