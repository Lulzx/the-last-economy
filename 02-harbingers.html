<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Harbingers of the Storm</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body { background: #fafaf8; color: #1a1a1a; font-family: system-ui, sans-serif; margin: 0; }
.prose { max-width: 680px; margin: 0 auto; padding: 2rem 1.5rem; font-family: Georgia, serif; line-height: 1.7; font-size: 1.05rem; }
.scrub { border-bottom: 2px dashed #2563eb; color: #2563eb; cursor: ew-resize; user-select: none; font-weight: 600; padding: 0 2px; }
.panel { background: white; border: 1px solid #e5e5e0; border-radius: 8px; padding: 1.5rem; margin: 2rem 0; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
.panel-full { background: white; border-top: 1px solid #e5e5e0; border-bottom: 1px solid #e5e5e0; padding: 2rem; margin: 2rem -1.5rem; }
h1 { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
h2 { font-size: 1.3rem; font-weight: 600; margin-top: 2rem; }
.chapter-num { color: #888; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; }
.nav { display: flex; justify-content: space-between; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e5e0; font-size: 0.9rem; }
.nav a { color: #2563eb; text-decoration: none; }

svg text { font-family: system-ui, sans-serif; }
.bar-label { font-size: 11px; fill: #555; }
.info-box { font-size: 0.95rem; color: #333; margin-top: 1rem; min-height: 2rem; }
.decade-btn { padding: 0.35rem 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 0.85rem; margin: 0.2rem; transition: all 0.15s; }
.decade-btn:hover { border-color: #2563eb; color: #2563eb; }
.decade-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
.btn-row { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 1rem; }

/* Flickering */
.flicker-row { margin: 1.5rem 0; }
.flicker-label { font-size: 0.9rem; color: #888; margin-bottom: 0.35rem; }
.flicker-track { height: 40px; background: linear-gradient(90deg, #2563eb22 0%, #2563eb22 100%); border-radius: 20px; position: relative; overflow: hidden; }
.flicker-thumb { position: absolute; top: 4px; width: 32px; height: 32px; background: #2563eb; border-radius: 50%; cursor: ew-resize; transition: left 0.05s; }
.flicker-poles { display: flex; justify-content: space-between; font-size: 0.8rem; color: #555; margin-top: 0.25rem; }
.flicker-current { text-align: center; font-weight: 600; font-size: 1.1rem; min-height: 1.5rem; margin-top: 0.5rem; }
.shimmer { animation: shimmer 0.15s infinite alternate; }
@keyframes shimmer { from { opacity: 1; } to { opacity: 0.4; } }

/* Grid */
.grid-container { display: inline-grid; grid-template-columns: repeat(6,44px); gap: 4px; }
.grid-cell { width: 44px; height: 44px; border-radius: 6px; background: #e0e7ff; cursor: pointer; transition: background 0.3s; border: 1px solid #c7d2fe; }
.grid-cell.shocked { background: #ef4444; border-color: #dc2626; }
.grid-cell.spread { background: #f97316; border-color: #ea580c; }
.year-toggle { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
.year-toggle button { padding: 0.4rem 1.2rem; border: 2px solid #ddd; background: white; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.95rem; }
.year-toggle button.active { border-color: #2563eb; background: #eff6ff; color: #2563eb; }

/* Gauges */
.gauges { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
.gauge { text-align: center; padding: 1rem; border-radius: 8px; border: 2px solid #e5e5e0; transition: border-color 0.3s; }
.gauge-name { font-size: 0.8rem; color: #888; margin-bottom: 0.3rem; }
.gauge-value { font-size: 1.1rem; font-weight: 700; }
.gauge.high .gauge-value { color: #d97706; }
.gauge.critical .gauge-value { color: #ef4444; }
.gauge.critical { border-color: #fca5a5; }
.dashboard-warning { text-align: center; padding: 1rem; margin-top: 1rem; border: 2px solid #ef4444; border-radius: 8px; background: #fef2f2; color: #b91c1c; font-weight: 600; display: none; }
.dashboard-warning.visible { display: block; }
</style>
</head>
<body>
<nav class="nav">
  <a href="01-intelligence-inversion.html">&larr; Previous</a>
  <a href="explorables.html">All Chapters</a>
  <a href="03-gdp-illusion.html">Next &rarr;</a>
</nav>

<div class="prose">
  <div class="chapter-num">Chapter 2</div>
  <h1>Harbingers of the Storm</h1>

  <p>Physics predicts phase transitions before they happen &mdash; through four warning signs: Critical Slowing Down, Variance Explosion, State Flickering, and Correlation Length growth. All four are active in our economy right now.</p>

  <!-- Panel 1: Critical Slowing Down -->
  <div class="panel">
    <h2>Critical Slowing Down</h2>
    <p style="font-size:0.9rem;color:#666;margin-top:0">Months to recover pre-recession employment. Click a bar for details.</p>
    <div id="slowdown-chart"></div>
    <div style="margin-top:1rem;">
      <div style="font-size:0.85rem;color:#888;margin-bottom:0.3rem;">System Resilience</div>
      <div id="resilience-meter" style="height:14px;background:#f1f1f1;border-radius:7px;overflow:hidden;">
        <div id="resilience-fill" style="height:100%;border-radius:7px;transition:width 0.4s;"></div>
      </div>
    </div>
    <div class="info-box" id="slowdown-info">Click a bar to learn more.</div>
  </div>

  <!-- Panel 2: Variance Explosion -->
  <div class="panel">
    <h2>Variance Explosion</h2>
    <div class="btn-row" id="decade-btns"></div>
    <div id="variance-chart"></div>
    <div class="info-box" id="variance-info"></div>
  </div>

  <!-- Panel 3: State Flickering -->
  <div class="panel">
    <h2>State Flickering</h2>
    <p style="font-size:0.9rem;color:#666;margin-top:0">Drag the indicators. Categories resist classification &mdash; a sign of criticality.</p>

    <div class="flicker-row">
      <div class="flicker-label">Uber Driver</div>
      <div class="flicker-track" id="flicker-uber">
        <div class="flicker-thumb" id="flicker-uber-thumb"></div>
      </div>
      <div class="flicker-poles"><span>Employee</span><span>Contractor</span></div>
      <div class="flicker-current" id="flicker-uber-label">Drag to classify</div>
    </div>

    <div class="flicker-row">
      <div class="flicker-label">Bitcoin</div>
      <div class="flicker-track" id="flicker-btc">
        <div class="flicker-thumb" id="flicker-btc-thumb"></div>
      </div>
      <div class="flicker-poles"><span>Currency</span><span>Asset</span><span>Security</span></div>
      <div class="flicker-current" id="flicker-btc-label">Drag to classify</div>
    </div>
  </div>

  <!-- Panel 4: Correlation Length -->
  <div class="panel">
    <h2>Correlation Length</h2>
    <div class="year-toggle">
      <button class="active" data-year="1980">1980</button>
      <button data-year="2021">2021</button>
    </div>
    <p style="font-size:0.9rem;color:#666;margin-top:0">Click a cell to shock it. Watch how far the disruption spreads.</p>
    <div class="grid-container" id="shock-grid"></div>
    <div class="info-box" id="grid-info" style="margin-top:1rem;font-size:0.85rem;color:#888;">
      2021 Ever Given (Suez Canal): 6-day blockage, $60B/day global impact.
    </div>
  </div>

  <!-- Panel 5: Combined Dashboard -->
  <div class="panel" id="dashboard-panel">
    <h2>Combined Dashboard</h2>
    <div class="gauges">
      <div class="gauge high"><div class="gauge-name">Critical Slowing Down</div><div class="gauge-value">HIGH</div></div>
      <div class="gauge high"><div class="gauge-name">Variance Explosion</div><div class="gauge-value">HIGH</div></div>
      <div class="gauge critical"><div class="gauge-name">State Flickering</div><div class="gauge-value">CRITICAL</div></div>
      <div class="gauge critical"><div class="gauge-name">Correlation Length</div><div class="gauge-value">CRITICAL</div></div>
    </div>
    <div class="dashboard-warning visible">System at criticality: 2 of 4 harbingers at CRITICAL</div>
  </div>
</div>

<script>
// ── Critical Slowing Down ──
(function() {
  const data = [
    { year: '1982', months: 16, desc: 'Volcker recession. Fed raised rates to 20% to break inflation. Recovery was sharp once rates dropped.' },
    { year: '1991', months: 23, desc: 'Savings & Loan crisis aftermath. Slower recovery signaled structural banking fragility.' },
    { year: '2001', months: 46, desc: 'Dot-com bust. "Jobless recovery" entered the lexicon. Offshoring accelerated.' },
    { year: '2008', months: 76, desc: 'Great Recession. 8.7M jobs lost. Recovery took 6+ years despite massive stimulus.' },
    { year: '2020', months: 29, desc: 'COVID crash. V-shaped recovery driven by $5T stimulus, but masked structural damage.' }
  ];
  const colorScale = d3.scaleLinear().domain([0, data.length - 1]).range(['#93c5fd', '#1e40af']);

  const w = 620, h = 200, m = { top: 10, right: 30, bottom: 25, left: 50 };
  const svg = d3.select('#slowdown-chart').append('svg')
    .attr('viewBox', `0 0 ${w} ${h}`).style('width', '100%');

  const x = d3.scaleLinear().domain([0, 80]).range([m.left, w - m.right]);
  const y = d3.scaleBand().domain(data.map(d => d.year)).range([m.top, h - m.bottom]).padding(0.3);

  svg.append('g').attr('transform', `translate(${m.left},0)`)
    .call(d3.axisLeft(y)).selectAll('text').style('font-size', '11px');
  svg.append('g').attr('transform', `translate(0,${h - m.bottom})`)
    .call(d3.axisBottom(x).ticks(5).tickFormat(d => d + ' mo')).selectAll('text').style('font-size', '10px');

  svg.selectAll('.bar').data(data).enter().append('rect')
    .attr('x', m.left).attr('y', d => y(d.year))
    .attr('width', d => x(d.months) - m.left).attr('height', y.bandwidth())
    .attr('fill', (d, i) => colorScale(i)).attr('rx', 3)
    .style('cursor', 'pointer')
    .on('click', function(e, d) {
      svg.selectAll('rect').attr('opacity', 0.4);
      d3.select(this).attr('opacity', 1);
      document.getElementById('slowdown-info').innerHTML = `<strong>${d.year}</strong> (${d.months} months): ${d.desc}`;
    });

  svg.selectAll('.bar-val').data(data).enter().append('text')
    .attr('x', d => x(d.months) + 5).attr('y', d => y(d.year) + y.bandwidth() / 2 + 4)
    .text(d => d.months + ' mo').style('font-size', '11px').style('fill', '#555');

  // Resilience meter — trend line excluding 2020 anomaly
  const trend = data.filter(d => d.year !== '2020');
  const avgRecovery = d3.mean(trend, d => d.months);
  const pct = Math.max(5, 100 - (avgRecovery / 80) * 100);
  const fill = document.getElementById('resilience-fill');
  fill.style.width = pct + '%';
  fill.style.background = pct < 40 ? '#ef4444' : pct < 60 ? '#d97706' : '#16a34a';
})();

// ── Variance Explosion ──
(function() {
  const decades = [
    { label: '1960s', val: 12 }, { label: '1970s', val: 18 }, { label: '1980s', val: 17 },
    { label: '1990s', val: 19 }, { label: '2000s', val: 22 }, { label: '2010s', val: 18 },
    { label: '2020s', val: 28 }
  ];

  const w = 620, h = 220, m = { top: 20, right: 20, bottom: 30, left: 45 };
  const svg = d3.select('#variance-chart').append('svg')
    .attr('viewBox', `0 0 ${w} ${h}`).style('width', '100%');

  const x = d3.scalePoint().domain(decades.map(d => d.label)).range([m.left, w - m.right]).padding(0.5);
  const y = d3.scaleLinear().domain([0, 35]).range([h - m.bottom, m.top]);

  svg.append('g').attr('transform', `translate(0,${h - m.bottom})`)
    .call(d3.axisBottom(x)).selectAll('text').style('font-size', '10px');
  svg.append('g').attr('transform', `translate(${m.left},0)`)
    .call(d3.axisLeft(y).ticks(5)).selectAll('text').style('font-size', '10px');

  svg.append('text').attr('transform', 'rotate(-90)').attr('x', -(h/2)).attr('y', 12)
    .attr('text-anchor', 'middle').style('font-size', '11px').style('fill', '#888').text('Avg Annual VIX');

  // Amplitude bands (hidden initially)
  const bands = svg.selectAll('.vband').data(decades).enter().append('rect')
    .attr('class', 'vband')
    .attr('x', d => x(d.label) - 25).attr('y', d => y(d.val))
    .attr('width', 50).attr('height', d => y(0) - y(d.val))
    .attr('fill', '#2563eb').attr('opacity', 0).attr('rx', 3);

  const line = d3.line().x(d => x(d.label)).y(d => y(d.val)).curve(d3.curveMonotoneX);
  svg.append('path').datum(decades).attr('d', line)
    .attr('fill', 'none').attr('stroke', '#2563eb').attr('stroke-width', 2.5);

  svg.selectAll('.dot').data(decades).enter().append('circle')
    .attr('cx', d => x(d.label)).attr('cy', d => y(d.val)).attr('r', 4)
    .attr('fill', '#2563eb');

  // 2020s annotation
  const last = decades[decades.length - 1];
  svg.append('text').attr('x', x(last.label)).attr('y', y(last.val) - 12)
    .attr('text-anchor', 'middle').style('font-size', '11px').style('fill', '#ef4444').style('font-weight', '600')
    .text('Unprecedented');
  svg.append('line')
    .attr('x1', x(last.label)).attr('y1', y(last.val) - 4)
    .attr('x2', x(last.label)).attr('y2', y(last.val) + 4)
    .attr('stroke', '#ef4444').attr('stroke-width', 1.5).attr('marker-end', '');

  // Buttons
  const btnRow = document.getElementById('decade-btns');
  decades.forEach((d, i) => {
    const btn = document.createElement('button');
    btn.className = 'decade-btn';
    btn.textContent = d.label;
    btn.onclick = () => {
      document.querySelectorAll('.decade-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      bands.transition().duration(200).attr('opacity', (_, j) => j === i ? 0.2 : 0);
      document.getElementById('variance-info').innerHTML =
        `<strong>${d.label}</strong>: Average VIX ~ ${d.val}` + (d.label === '2020s' ? ' &mdash; highest sustained volatility on record.' : '');
    };
    btnRow.appendChild(btn);
  });
})();

// ── State Flickering ──
(function() {
  function setupFlicker(trackId, thumbId, labelId, states) {
    const track = document.getElementById(trackId);
    const thumb = document.getElementById(thumbId);
    const label = document.getElementById(labelId);
    const trackW = track.offsetWidth || 300;
    let pct = 0.5;

    function render() {
      const left = Math.max(0, Math.min(1, pct)) * (trackW - 32);
      thumb.style.left = left + 'px';
      const idx = Math.min(states.length - 1, Math.floor(pct * states.length));
      const center = 1 / states.length;
      const distFromCenter = states.length === 2
        ? Math.abs(pct - 0.5)
        : Math.min(...states.map((_, i) => Math.abs(pct - (i + 0.5) / states.length)));
      const isNearEdge = distFromCenter < 0.12;
      label.textContent = states[idx];
      if (isNearEdge) {
        label.classList.add('shimmer');
      } else {
        label.classList.remove('shimmer');
      }
    }

    let dragging = false;
    thumb.addEventListener('mousedown', e => { dragging = true; e.preventDefault(); });
    document.addEventListener('mousemove', e => {
      if (!dragging) return;
      const rect = track.getBoundingClientRect();
      pct = (e.clientX - rect.left) / rect.width;
      pct = Math.max(0, Math.min(1, pct));
      render();
    });
    document.addEventListener('mouseup', () => { dragging = false; });
    // Touch
    thumb.addEventListener('touchstart', e => { dragging = true; e.preventDefault(); });
    document.addEventListener('touchmove', e => {
      if (!dragging) return;
      const rect = track.getBoundingClientRect();
      pct = (e.touches[0].clientX - rect.left) / rect.width;
      pct = Math.max(0, Math.min(1, pct));
      render();
    });
    document.addEventListener('touchend', () => { dragging = false; });
    render();
  }

  // Delay to allow layout
  requestAnimationFrame(() => {
    setupFlicker('flicker-uber', 'flicker-uber-thumb', 'flicker-uber-label', ['Employee', 'Contractor']);
    setupFlicker('flicker-btc', 'flicker-btc-thumb', 'flicker-btc-label', ['Currency', 'Asset', 'Security']);
  });
})();

// ── Correlation Length ──
(function() {
  let currentYear = 1980;
  const gridEl = document.getElementById('shock-grid');
  const cells = [];

  // Build grid
  for (let i = 0; i < 36; i++) {
    const cell = document.createElement('div');
    cell.className = 'grid-cell';
    cell.dataset.idx = i;
    gridEl.appendChild(cell);
    cells.push(cell);
  }

  function resetGrid() {
    cells.forEach(c => { c.className = 'grid-cell'; });
  }

  function neighbors(idx) {
    const row = Math.floor(idx / 6), col = idx % 6;
    const n = [];
    if (row > 0) n.push(idx - 6);
    if (row < 5) n.push(idx + 6);
    if (col > 0) n.push(idx - 1);
    if (col < 5) n.push(idx + 1);
    return n;
  }

  function shock(idx) {
    resetGrid();
    cells[idx].classList.add('shocked');
    if (currentYear === 1980) {
      // Spread to 1-2 adjacent
      const adj = neighbors(idx);
      const spread = adj.slice(0, 1 + Math.floor(Math.random() * 2));
      spread.forEach((n, i) => {
        setTimeout(() => cells[n].classList.add('spread'), 200 + i * 150);
      });
    } else {
      // Cascade to entire grid
      const visited = new Set([idx]);
      let frontier = [idx];
      let delay = 0;
      function step() {
        delay += 120;
        const next = [];
        frontier.forEach(f => {
          neighbors(f).forEach(n => {
            if (!visited.has(n)) {
              visited.add(n);
              next.push(n);
              setTimeout(() => cells[n].classList.add('spread'), delay + Math.random() * 80);
            }
          });
        });
        frontier = next;
        if (frontier.length > 0) step();
      }
      step();
    }
  }

  cells.forEach((c, i) => c.addEventListener('click', () => shock(i)));

  document.querySelectorAll('.year-toggle button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.year-toggle button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentYear = parseInt(btn.dataset.year);
      resetGrid();
    });
  });
})();
</script>
</body>
</html>
