<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cooperation Emerges</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300;1,400;1,500&family=DM+Sans:ital,opsz,wght@0,9..40,100..900;1,9..40,100..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body { background: #fafaf8; color: #1a1a1a; font-family: 'DM Sans', system-ui, sans-serif; margin: 0; }
.prose { max-width: 680px; margin: 0 auto; padding: 2rem 1.5rem; font-family: 'DM Sans', system-ui, sans-serif; line-height: 1.7; font-size: 1.05rem; }
.scrub { border-bottom: 2px dashed #2563eb; color: #2563eb; cursor: ew-resize; user-select: none; font-weight: 600; padding: 0 2px; }
.panel { background: white; border: 1px solid #e5e5e0; border-radius: 8px; padding: 1.5rem; margin: 2rem 0; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
h1 { font-family: 'Playfair Display', Georgia, serif; font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
h2 { font-family: 'Playfair Display', Georgia, serif; font-size: 1.3rem; font-weight: 600; margin-top: 2rem; }
.chapter-num { color: #888; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; }
.nav { display: flex; justify-content: space-between; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e5e0; font-size: 0.9rem; }
.nav a { color: #2563eb; text-decoration: none; }
svg text { font-family: 'DM Sans', system-ui, sans-serif; }
.btn { background: #2563eb; color: white; border: none; padding: 0.5rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin: 0.25rem; font-family: 'DM Sans', system-ui, sans-serif; }
.btn:hover { background: #1d4ed8; }
.btn.active { background: #2563eb; color: white; box-shadow: 0 0 0 2px #93c5fd; }
.btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0; }
.stat { font-size: 0.9rem; color: #555; margin: 0.5rem 0; }
.stat strong { color: #1a1a1a; }
input[type="range"] { width: 100%; margin: 0.25rem 0; accent-color: #2563eb; }
.slider-label { display: flex; justify-content: space-between; font-size: 0.85rem; color: #555; }
.slider-row { margin: 0.75rem 0; }
.slider-row label { font-size: 0.9rem; font-weight: 600; display: block; margin-bottom: 0.25rem; }
.matrix { display: grid; grid-template-columns: auto 1fr 1fr; gap: 0; font-size: 0.85rem; margin: 1rem 0; border: 1px solid #e5e5e0; border-radius: 6px; overflow: hidden; }
.matrix div { padding: 0.5rem 0.75rem; border: 1px solid #e5e5e0; text-align: center; }
.matrix .header { background: #f5f5f3; font-weight: 600; }
.results-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin: 1rem 0; text-align: center; }
.results-grid .val { font-size: 1.5rem; font-weight: 700; color: #2563eb; }
.results-grid .lbl { font-size: 0.8rem; color: #888; }
.leaderboard { margin: 1rem 0; }
.leaderboard .entry { display: flex; justify-content: space-between; padding: 0.5rem 0.75rem; border-bottom: 1px solid #f0f0ed; font-size: 0.9rem; }
.leaderboard .entry:first-child { background: #eff6ff; font-weight: 600; border-radius: 6px 6px 0 0; }
.leaderboard .rank { color: #888; width: 2rem; }
.caption { font-size: 0.9rem; color: #666; font-style: italic; margin-top: 1rem; }
.case-card { border: 1px solid #e5e5e0; border-radius: 8px; padding: 1rem; margin: 0.75rem 0; cursor: pointer; transition: all 0.2s; }
.case-card:hover { border-color: #2563eb; }
.case-card h3 { font-family: 'Playfair Display', Georgia, serif; margin: 0 0 0.25rem; font-size: 1rem; }
.case-card .big-stat { font-size: 1.8rem; font-weight: 700; color: #2563eb; margin: 0.5rem 0; }
.case-card .detail { display: none; font-size: 0.9rem; color: #555; margin-top: 0.75rem; line-height: 1.6; }
.case-card.open .detail { display: block; }
.pullquote { border-left: 4px solid #2563eb; margin: 2rem 0; padding: 1rem 1.5rem; background: #eff6ff; border-radius: 0 8px 8px 0; }
.pullquote p { font-size: 1.15rem; font-style: italic; color: #1e40af; margin: 0; }
.pullquote .attribution { font-size: 0.85rem; font-style: normal; color: #555; margin-top: 0.5rem; }
.stat-callout { display: flex; flex-direction: column; align-items: center; padding: 1.5rem; background: white; border: 1px solid #e5e5e0; border-radius: 8px; margin: 1.5rem 0; text-align: center; }
.stat-number { font-family: 'Playfair Display', Georgia, serif; font-size: 3rem; font-weight: 700; color: #2563eb; line-height: 1; }
.stat-label { font-size: 0.9rem; color: #555; margin-top: 0.5rem; }
.section-divider { border: none; border-top: 1px solid #e5e5e0; margin: 3rem 0; }
.stat-row { display: flex; gap: 1rem; flex-wrap: wrap; }
.stat-row .stat-callout { flex: 1; min-width: 180px; }
</style>
</head>
<body>
<nav class="nav">
  <a href="ch11-cathedral-bazaar.html">&larr; Previous</a>
  <a href="explorables.html">All Chapters</a>
  <a href="ch13-dual-engine.html">Next &rarr;</a>
</nav>

<div class="prose">
  <div class="chapter-num">Chapter 12</div>
  <h1>Cooperation Emerges</h1>

  <div class="pullquote">
    <p>&ldquo;The calculus of probabilities, in its application to game theory, is a monstrously complicated subject&hellip; It is not a topic for a gentleman.&rdquo;</p>
    <div class="attribution">&mdash; John von Neumann</div>
  </div>

  <p>Cooperation isn&rsquo;t idealism. In repeated games with memory, it is the mathematically optimal selfish strategy. The prisoner&rsquo;s dilemma isn&rsquo;t a story about morality &mdash; it&rsquo;s a story about time horizons and information.</p>

  <!-- Section: The Prisoner's Enlightenment -->
  <h2>The Prisoner&rsquo;s Enlightenment</h2>

  <p>The Prisoner&rsquo;s Dilemma is philosophy&rsquo;s most depressing party trick. Two prisoners, unable to communicate, must choose whether to cooperate or to betray their partner. The math is brutal. Whatever your partner does, you are better off defecting. So both defect. Both suffer a harsher sentence than if they had cooperated. Rationality itself seems to doom us to mutual destruction.</p>

  <p>In 1950, when this was formalized at the RAND Corporation, it became the cold logic of the Cold War. Whatever the Soviets do, we are better off building more bombs. Whatever we do, they are better off building more bombs. The Nash Equilibrium is a planet of rubble.</p>

  <!-- SVG: From Defection to Cooperation -->
  <svg viewBox="0 0 600 140" style="width:100%; max-width:600px; display:block; margin:2rem auto;">
    <defs>
      <marker id="arrow-blue" markerWidth="8" markerHeight="8" refX="8" refY="4" orient="auto">
        <path d="M0,0 L8,4 L0,8 Z" fill="#2563eb"/>
      </marker>
    </defs>
    <!-- One-shot game -->
    <rect x="20" y="20" width="160" height="100" rx="8" fill="#fef2f2" stroke="#ef4444" stroke-width="1.5"/>
    <text x="100" y="50" text-anchor="middle" font-size="12" font-weight="600" fill="#991b1b">One-Shot Game</text>
    <text x="100" y="72" text-anchor="middle" font-size="11" fill="#555">No memory, no future</text>
    <text x="100" y="92" text-anchor="middle" font-size="18" font-weight="700" fill="#ef4444">Defect</text>
    <!-- Arrow -->
    <line x1="195" y1="70" x2="235" y2="70" stroke="#2563eb" stroke-width="2" marker-end="url(#arrow-blue)"/>
    <text x="215" y="58" text-anchor="middle" font-size="9" fill="#2563eb">+ iteration</text>
    <!-- Iterated game -->
    <rect x="245" y="20" width="160" height="100" rx="8" fill="#fefce8" stroke="#eab308" stroke-width="1.5"/>
    <text x="325" y="50" text-anchor="middle" font-size="12" font-weight="600" fill="#854d0e">Iterated Game</text>
    <text x="325" y="72" text-anchor="middle" font-size="11" fill="#555">Memory + reputation</text>
    <text x="325" y="92" text-anchor="middle" font-size="18" font-weight="700" fill="#eab308">Tit-for-Tat</text>
    <!-- Arrow -->
    <line x1="420" y1="70" x2="460" y2="70" stroke="#2563eb" stroke-width="2" marker-end="url(#arrow-blue)"/>
    <text x="440" y="58" text-anchor="middle" font-size="9" fill="#2563eb">+ topology</text>
    <!-- Symbiotic game -->
    <rect x="470" y="20" width="120" height="100" rx="8" fill="#eff6ff" stroke="#2563eb" stroke-width="1.5"/>
    <text x="530" y="50" text-anchor="middle" font-size="12" font-weight="600" fill="#1e40af">Symbiotic</text>
    <text x="530" y="72" text-anchor="middle" font-size="11" fill="#555">Network effects</text>
    <text x="530" y="92" text-anchor="middle" font-size="18" font-weight="700" fill="#2563eb">Cooperate</text>
  </svg>

  <p>But then, in the 1980s, the political scientist Robert Axelrod did something beautiful. He ran a tournament &mdash; not with prisoners, but with computer programs. He invited strategists to submit algorithms that would compete in an iterated Prisoner&rsquo;s Dilemma, a game played thousands of times. The winner shocked everyone. It was the simplest program submitted, a four-line piece of code called &ldquo;Tit for Tat.&rdquo; Cooperate on the first move, then do whatever your opponent did last.</p>

  <div class="pullquote">
    <p>Tit for Tat did not win because it was moral. It won because it was mathematically optimal in a game that had memory and a future. Cooperation emerged not from ethics but from iteration. Not from intention but from interaction.</p>
  </div>

  <!-- Panel 1: Prisoner's Dilemma Playground -->
  <div class="panel">
    <h2>Prisoner&rsquo;s Dilemma Playground</h2>
    <div class="matrix">
      <div class="header"></div><div class="header">B: Cooperate</div><div class="header">B: Defect</div>
      <div class="header">A: Cooperate</div><div>3, 3</div><div>0, 5</div>
      <div class="header">A: Defect</div><div>5, 0</div><div>1, 1</div>
    </div>
    <div class="slider-row">
      <label>Iterations: <span id="iter-val">50</span></label>
      <input type="range" id="iter-slider" min="1" max="200" value="50">
    </div>
    <div class="slider-row">
      <label>Reputation Visibility: <span id="rep-val">50%</span></label>
      <input type="range" id="rep-slider" min="0" max="100" value="50">
    </div>
    <div class="slider-row">
      <label>Time Horizon: <span id="horizon-val">50</span></label>
      <input type="range" id="horizon-slider" min="1" max="200" value="50">
    </div>
    <button class="btn" onclick="runPD()">Run Game</button>
    <div class="results-grid" id="pd-results" style="display:none;">
      <div><div class="val" id="pd-a-score">0</div><div class="lbl">A's Score</div></div>
      <div><div class="val" id="pd-b-score">0</div><div class="lbl">B's Score</div></div>
      <div><div class="val" id="pd-coop">0%</div><div class="lbl">Mutual Cooperation</div></div>
    </div>
    <svg id="pd-chart" style="display:block; width:100%; max-width:600px;" height="160"></svg>
  </div>

  <hr class="section-divider">

  <!-- Section: The Flaw in the Old Game -->
  <h2>The Flaw in the Old Game</h2>

  <p>Classical game theory made a fatal error. It assumed its agents were intelligent but its universe was stupid. It modeled players who operated in a vacuum &mdash; a featureless void with no context, no relationships, and no consequences beyond the immediate transaction.</p>

  <p>The famous paradoxes of game theory are not paradoxes of human irrationality. They are the predictable outcomes of games played on impoverished landscapes. The Prisoner&rsquo;s Dilemma is so bleak because its &ldquo;prison&rdquo; is a metaphor for a specific, pathological topology: a disconnected, zero-information graph with no future. The prisoners cannot communicate. They have no basis for trust. It is a one-shot game, so reputation is worthless.</p>

  <div class="pullquote">
    <p>The tragedy is not that humans are flawed, but that classical game theory mistook this pathological edge case for the universal condition.</p>
  </div>

  <p>An even deeper puzzle, the <strong>Traveler&rsquo;s Dilemma</strong>, reveals the dimensional blindness of the old framework. In this game, the purely &ldquo;rational&rdquo; strategy leads to the worst possible collective outcome. Yet in experiments, real humans consistently choose to cooperate, achieving a far better result. The paradox is not that humans are irrational; it&rsquo;s that classical game theory is blind &mdash; capable of seeing only Material Capital while humans intuitively navigate all four.</p>

  <!-- Panel 2: Strategy Tournament -->
  <div class="panel">
    <h2>Strategy Tournament</h2>
    <p style="font-size:0.9rem; color:#666;">Six strategies compete in a round-robin tournament of 200 rounds each. Run it to see which approach wins.</p>
    <button class="btn" onclick="runTournament()">Run Tournament</button>
    <div class="leaderboard" id="tournament-board"></div>
    <p class="caption" id="tournament-caption" style="display:none;">Tit-for-Tat wins not by being moral, but by being clear, reciprocal, and forgiving.</p>
  </div>

  <hr class="section-divider">

  <!-- Section: The Logic of the Potlatch -->
  <h2>The Logic of the Potlatch</h2>

  <p>Western observers in the 19th century were baffled by the potlatch &mdash; a vast ceremonial feast held by the Kwakwaka&rsquo;wakw and other Indigenous peoples of the Pacific Northwest. Here was a society where chiefs would spend years accumulating immense wealth, only to give it all away, or even dramatically destroy it, in a single, massive ceremony. To the scarcity mindset of the colonial administrator, this was madness. They banned it, missing the genius entirely.</p>

  <!-- SVG: Capital Transmutation -->
  <svg viewBox="0 0 600 160" style="width:100%; max-width:600px; display:block; margin:2rem auto;">
    <defs>
      <marker id="arrow-green" markerWidth="8" markerHeight="8" refX="8" refY="4" orient="auto">
        <path d="M0,0 L8,4 L0,8 Z" fill="#16a34a"/>
      </marker>
    </defs>
    <!-- Material Capital -->
    <rect x="30" y="30" width="150" height="100" rx="10" fill="#fef2f2" stroke="#ef4444" stroke-width="1.5"/>
    <text x="105" y="60" text-anchor="middle" font-size="13" font-weight="700" fill="#991b1b">Material Capital</text>
    <text x="105" y="80" text-anchor="middle" font-size="11" fill="#555">1,000 blankets</text>
    <text x="105" y="98" text-anchor="middle" font-size="10" fill="#888">Rivalrous, depletable</text>
    <!-- Arrow -->
    <line x1="195" y1="80" x2="255" y2="80" stroke="#16a34a" stroke-width="2.5" marker-end="url(#arrow-green)"/>
    <text x="225" y="68" text-anchor="middle" font-size="10" font-weight="600" fill="#16a34a">Potlatch</text>
    <!-- Network Capital -->
    <rect x="270" y="30" width="150" height="100" rx="10" fill="#eff6ff" stroke="#2563eb" stroke-width="1.5"/>
    <text x="345" y="60" text-anchor="middle" font-size="13" font-weight="700" fill="#1e40af">Network Capital</text>
    <text x="345" y="80" text-anchor="middle" font-size="11" fill="#555">1,000 obligations</text>
    <text x="345" y="98" text-anchor="middle" font-size="10" fill="#888">Non-rivalrous, resilient</text>
    <!-- Insight -->
    <text x="495" y="60" text-anchor="middle" font-size="11" fill="#555">The richest chief =</text>
    <text x="495" y="80" text-anchor="middle" font-size="12" font-weight="700" fill="#2563eb">strongest web of</text>
    <text x="495" y="98" text-anchor="middle" font-size="12" font-weight="700" fill="#2563eb">relationships</text>
  </svg>

  <p>The potlatch was not about destroying wealth. It was about <em>transmuting</em> it. When a chief gave away a thousand blankets, he was not losing a thousand blankets. He was purchasing a thousand strands of social obligation. He was broadcasting a signal of his capacity and his generosity, creating a network of allies. They were not playing a zero-sum game for a fixed pool of resources. They were playing a positive-sum game to increase the resilience and prosperity of the entire network.</p>

  <hr class="section-divider">

  <!-- Section: The Selfishness of Generosity -->
  <h2>The Selfishness of Generosity</h2>

  <p>Here is the paradox that breaks most minds. In a sufficiently connected system with a long enough time horizon, selfishness and altruism converge. Being generous becomes the most selfish possible strategy &mdash; not in some mystical sense, but in pure mathematical returns.</p>

  <div class="stat-callout">
    <div class="stat-number">$1T+</div>
    <div class="stat-label">Estimated economic value generated by the open Human Genome Project data</div>
  </div>

  <p>Consider the Human Genome Project. In the 1990s, a race began between a public, open-source consortium and a private company to sequence our DNA. The public project shared its data freely every 24 hours. The private company kept its data proprietary, hoping to sell access. The open model won. The contributors gave away their work and got back a transformed world.</p>

  <div class="pullquote">
    <p>The old game was about extracting value from the network. The new game is about generating value <em>through</em> the network.</p>
  </div>

  <!-- Panel 3: Topology x Cooperation -->
  <div class="panel">
    <h2>Topology &times; Cooperation</h2>
    <p style="font-size:0.9rem; color:#666;">Watch how defection (red) spreads through different network structures. Mesh networks resist contagion; hub-and-spoke collapses fast.</p>
    <div class="btn-group">
      <button class="btn" onclick="setTopology('hub')">Hub-and-Spoke</button>
      <button class="btn" onclick="setTopology('smallworld')">Small-World</button>
      <button class="btn" onclick="setTopology('mesh')">Mesh</button>
    </div>
    <svg id="spread-svg" style="display:block; width:100%; max-width:600px;" height="360"></svg>
    <div id="spread-stat" class="stat" style="text-align:center;"></div>
  </div>

  <hr class="section-divider">

  <!-- Section: The Principal-Agent Problem -->
  <h2>Aligning the Players</h2>

  <p>The failure of classical game theory is not just academic; it manifests in every boardroom. The &ldquo;Principal-Agent Problem&rdquo; &mdash; the struggle to align the interests of a CEO with their shareholders &mdash; has consumed corporate governance for fifty years. Conventional economics tries to solve this with better contracts, a classic attempt to write more complex rules for a broken game.</p>

  <p>The symbiotic solution is not to write a better contract, but to reshape the landscape. Structures like cooperatives, which give the &ldquo;agent&rdquo; employee ownership and a stake in long-term health, are acts of topology engineering. They change the game itself, making the agent&rsquo;s and the principal&rsquo;s paths of least resistance converge toward the <strong>Symbiotic Equilibrium</strong>.</p>

  <hr class="section-divider">

  <!-- Section: From Nash to Symbiosis -->
  <h2>From Nash to Symbiosis</h2>

  <p>A Nash Equilibrium is a state where no player can improve their outcome by unilaterally changing their strategy. It is a state of selfish stability. The Prisoner&rsquo;s Dilemma shows us that this can often be a terrible place.</p>

  <p>Intelligent Game Theory introduces a new, higher equilibrium: the <strong>Symbiotic Equilibrium</strong>. This is a state where the system&rsquo;s overall health is maximized. In this state, an individual agent cannot improve its own long-term prospects by taking an action that degrades the health of the network.</p>

  <!-- SVG: Nash vs Symbiotic Equilibrium -->
  <svg viewBox="0 0 600 170" style="width:100%; max-width:600px; display:block; margin:2rem auto;">
    <!-- Nash Equilibrium -->
    <rect x="30" y="20" width="240" height="130" rx="10" fill="#fef2f2" stroke="#ef4444" stroke-width="1.5"/>
    <text x="150" y="50" text-anchor="middle" font-size="14" font-weight="700" fill="#991b1b">Nash Equilibrium</text>
    <text x="150" y="75" text-anchor="middle" font-size="11" fill="#555">No player can improve alone</text>
    <text x="150" y="95" text-anchor="middle" font-size="11" fill="#555">Selfish stability</text>
    <text x="150" y="120" text-anchor="middle" font-size="11" fill="#888">Can be globally terrible</text>
    <!-- Symbiotic Equilibrium -->
    <rect x="330" y="20" width="240" height="130" rx="10" fill="#eff6ff" stroke="#2563eb" stroke-width="1.5"/>
    <text x="450" y="50" text-anchor="middle" font-size="14" font-weight="700" fill="#1e40af">Symbiotic Equilibrium</text>
    <text x="450" y="75" text-anchor="middle" font-size="11" fill="#555">System health is maximized</text>
    <text x="450" y="95" text-anchor="middle" font-size="11" fill="#555">No gain from degrading network</text>
    <text x="450" y="120" text-anchor="middle" font-size="11" fill="#2563eb" font-weight="600">Locally + globally optimal</text>
    <!-- Arrow between them -->
    <text x="300" y="85" text-anchor="middle" font-size="22" fill="#16a34a">&#8594;</text>
    <text x="300" y="105" text-anchor="middle" font-size="9" fill="#16a34a" font-weight="600">Goal of policy</text>
  </svg>

  <div class="pullquote">
    <p>The goal of policy in the 21st century is to design systems where the Nash Equilibrium and the Symbiotic Equilibrium are the same. This is not about changing human nature. It is about changing the math of the game.</p>
  </div>

  <hr class="section-divider">

  <!-- Section: The Computation of Trust -->
  <h2>The Computation of Trust</h2>

  <p>Classical game theory failed because it assumed a world of disconnected transactions. To cooperate, its prisoners needed to trust each other, and trust was a variable it could not model.</p>

  <p>This is precisely the problem that modern AI and cryptographic systems are built to solve. Consider a multi-agent AI system managing a supply chain. The AIs will learn to cooperate not because of a moral code, but because they will mathematically discover that transparent, shared ledgers and verifiable commitments dramatically reduce their collective prediction error.</p>

  <p>Trust, in this new world, is not an emotion. It is a computational feature. The most successful systems will be those that engineer trust into their very architecture &mdash; building games where cooperation is not a matter of hope, but a matter of mathematical certainty.</p>

  <hr class="section-divider">

  <!-- Panel 4: Real-World Proof -->
  <h2>Dispatches from a Future That Already Works</h2>

  <p>These are not quaint experiments. They are proof that an economy built on symbiosis is not just more humane, but mathematically more efficient and robust.</p>

  <div class="stat-row">
    <div class="stat-callout">
      <div class="stat-number">0%</div>
      <div class="stat-label">Mondragon internal unemployment during the 2008 crisis</div>
    </div>
    <div class="stat-callout">
      <div class="stat-number">8%</div>
      <div class="stat-label">Buurtzorg overhead vs. 24% industry standard</div>
    </div>
    <div class="stat-callout">
      <div class="stat-number">4 lines</div>
      <div class="stat-label">of code in Tit-for-Tat, the winning strategy</div>
    </div>
  </div>

  <div class="panel">
    <h2>Real-World Proof</h2>

    <div class="case-card" onclick="this.classList.toggle('open')">
      <h3>Mondragon 2008</h3>
      <div class="big-stat">0% internal unemployment</div>
      <p style="font-size:0.85rem; color:#888;">vs. Spain's 26% peak</p>
      <div class="detail">During the 2008 financial crisis, the Mondragon Corporation &mdash; a federation of 80,000 worker-owners in the Basque Country of Spain &mdash; faced the crisis with an internal unemployment rate of zero percent while the rest of the country suffered at twenty-six. Workers voted to reduce hours and pay rather than fire colleagues. Cooperation, encoded in ownership structure, produced resilience that hierarchical firms could not match.</div>
    </div>

    <div class="case-card" onclick="this.classList.toggle('open')">
      <h3>Buurtzorg</h3>
      <div class="big-stat">8% overhead</div>
      <p style="font-size:0.85rem; color:#888;">vs. 24% industry standard</p>
      <div class="detail">15,000 nurses in the Netherlands. No managers. 8% overhead vs. 24% industry standard &mdash; a third of the industry norm. Patients recover 40% faster. Each team of 12 is self-managing. Trust replaces supervision. Cooperation emerges from small, autonomous groups with shared purpose, delivering the nation&rsquo;s highest-rated patient care.</div>
    </div>

    <div class="case-card" onclick="this.classList.toggle('open')">
      <h3>Linux Kernel</h3>
      <div class="big-stat">~30M lines of code</div>
      <p style="font-size:0.85rem; color:#888;">produced by voluntary cooperation</p>
      <div class="detail">Produced by voluntary cooperation. Powers 96% of top 1M web servers, all Android phones, most of the internet's infrastructure. The GPL license enforces cooperation by code: you can use it, but you must share improvements. Cooperation, once structurally encoded, scales without limit.</div>
    </div>

    <div class="case-card" onclick="this.classList.toggle('open')">
      <h3>Human Genome Project</h3>
      <div class="big-stat">$1T+ value</div>
      <p style="font-size:0.85rem; color:#888;">from freely shared public data</p>
      <div class="detail">In the 1990s, a race began between an open consortium and a private company to sequence human DNA. The public project shared data freely every 24 hours. The private company kept data proprietary. The open model won, generating an estimated trillion dollars in economic value and creating entire new industries. The contributors gave away their work and got back a transformed world.</div>
    </div>
  </div>
</div>

<script>
// ========== Panel 1: Prisoner's Dilemma ==========
function runPD() {
  const iters = +document.getElementById('iter-slider').value;
  const rep = +document.getElementById('rep-slider').value / 100;
  const horizon = +document.getElementById('horizon-slider').value;

  const coopProb = Math.min(0.95, rep * 0.6 + (horizon / 200) * 0.35 + (iters > 5 ? 0.1 : 0));
  let aScore = 0, bScore = 0, coopRounds = 0;
  const rounds = [];
  let aLastCoop = true, bLastCoop = true;

  for (let i = 0; i < iters; i++) {
    const endEffect = (iters - i) < 3 && rep < 0.5 ? 0.7 : 0;
    const aCoop = Math.random() < (coopProb - endEffect) && (i === 0 || bLastCoop || Math.random() < rep * 0.3);
    const bCoop = Math.random() < (coopProb - endEffect) && (i === 0 || aLastCoop || Math.random() < rep * 0.3);

    if (aCoop && bCoop) { aScore += 3; bScore += 3; coopRounds++; }
    else if (aCoop && !bCoop) { aScore += 0; bScore += 5; }
    else if (!aCoop && bCoop) { aScore += 5; bScore += 0; }
    else { aScore += 1; bScore += 1; }

    rounds.push({ round: i, aCoop, bCoop });
    aLastCoop = aCoop; bLastCoop = bCoop;
  }

  document.getElementById('pd-results').style.display = 'grid';
  document.getElementById('pd-a-score').textContent = aScore;
  document.getElementById('pd-b-score').textContent = bScore;
  document.getElementById('pd-coop').textContent = Math.round(coopRounds / iters * 100) + '%';

  const svg = d3.select('#pd-chart');
  svg.selectAll('*').remove();
  const w = svg.node().clientWidth || 600;
  const h = 160, m = { t: 10, r: 10, b: 25, l: 30 };
  const x = d3.scaleLinear().domain([0, iters - 1]).range([m.l, w - m.r]);
  const barW = Math.max(1, (w - m.l - m.r) / iters - 0.5);

  svg.attr('viewBox', `0 0 ${w} ${h}`);

  svg.selectAll('.bar').data(rounds).enter().append('rect')
    .attr('x', d => x(d.round)).attr('y', m.t)
    .attr('width', barW).attr('height', (h - m.t - m.b) / 2 - 2)
    .attr('fill', d => d.aCoop ? '#3b82f6' : '#ef4444').attr('rx', 1);
  svg.selectAll('.bar2').data(rounds).enter().append('rect')
    .attr('x', d => x(d.round)).attr('y', m.t + (h - m.t - m.b) / 2 + 2)
    .attr('width', barW).attr('height', (h - m.t - m.b) / 2 - 2)
    .attr('fill', d => d.bCoop ? '#3b82f6' : '#ef4444').attr('rx', 1);

  svg.append('text').attr('x', 5).attr('y', m.t + 20).attr('font-size', 10).attr('fill', '#888').text('A');
  svg.append('text').attr('x', 5).attr('y', m.t + (h - m.t - m.b) / 2 + 22).attr('font-size', 10).attr('fill', '#888').text('B');
  svg.append('text').attr('x', w / 2).attr('y', h - 3).attr('text-anchor', 'middle').attr('font-size', 10).attr('fill', '#aaa').text('Blue = Cooperate, Red = Defect');
}

['iter-slider', 'rep-slider', 'horizon-slider'].forEach(id => {
  document.getElementById(id).addEventListener('input', function() {
    const map = { 'iter-slider': 'iter-val', 'rep-slider': 'rep-val', 'horizon-slider': 'horizon-val' };
    const suffix = id === 'rep-slider' ? '%' : '';
    document.getElementById(map[id]).textContent = this.value + suffix;
  });
});

// ========== Panel 2: Strategy Tournament ==========
function runTournament() {
  const strategies = {
    'Always Defect': (myHist, theirHist) => false,
    'Always Cooperate': (myHist, theirHist) => true,
    'Random (50/50)': (myHist, theirHist) => Math.random() > 0.5,
    'Tit-for-Tat': (myHist, theirHist) => theirHist.length === 0 ? true : theirHist[theirHist.length - 1],
    'Generous TfT': (myHist, theirHist) => theirHist.length === 0 ? true : (theirHist[theirHist.length - 1] || Math.random() < 0.1),
    'Grim Trigger': (myHist, theirHist) => !theirHist.includes(false),
  };
  const names = Object.keys(strategies);
  const scores = {};
  names.forEach(n => scores[n] = 0);

  for (let i = 0; i < names.length; i++) {
    for (let j = 0; j < names.length; j++) {
      if (i === j) continue;
      let histI = [], histJ = [];
      for (let r = 0; r < 200; r++) {
        const a = strategies[names[i]](histI, histJ);
        const b = strategies[names[j]](histJ, histI);
        if (a && b) { scores[names[i]] += 3; }
        else if (a && !b) { scores[names[i]] += 0; }
        else if (!a && b) { scores[names[i]] += 5; }
        else { scores[names[i]] += 1; }
        histI.push(a); histJ.push(b);
      }
    }
  }

  const ranked = names.map(n => ({ name: n, score: scores[n] })).sort((a, b) => b.score - a.score);
  const board = document.getElementById('tournament-board');
  board.innerHTML = ranked.map((r, i) => `<div class="entry"><span class="rank">#${i + 1}</span><span>${r.name}</span><span style="font-weight:600;">${r.score.toLocaleString()}</span></div>`).join('');
  document.getElementById('tournament-caption').style.display = 'block';
}

// ========== Panel 3: Topology x Cooperation ==========
var activeTopology = null;

function setTopology(type) {
  // Update active button state
  document.querySelectorAll('#spread-svg').forEach(el => el);
  const btns = document.querySelectorAll('.btn-group .btn');
  btns.forEach(b => b.classList.remove('active'));
  event.currentTarget.classList.add('active');
  activeTopology = type;
  runSpread(type);
}

function runSpread(type) {
  const N = 64;
  const cols = 8, rows = 8;
  const svg = d3.select('#spread-svg');
  svg.selectAll('*').remove();
  const w = svg.node().clientWidth || 600;
  const h = 360;
  const cw = w / cols;
  const ch = (h - 40) / rows;
  const ox = 0, oy = 20;

  svg.attr('viewBox', `0 0 ${w} ${h}`);

  // Build adjacency
  const adj = Array.from({ length: N }, () => []);
  if (type === 'hub') {
    const hub = 0;
    for (let i = 1; i < N; i++) { adj[hub].push(i); adj[i].push(hub); }
  } else if (type === 'smallworld') {
    for (let i = 0; i < N; i++) {
      [1, 2].forEach(d => { const j = (i + d) % N; adj[i].push(j); adj[j].push(i); });
    }
    for (let i = 0; i < 6; i++) {
      const a = Math.floor(Math.random() * N), b = Math.floor(Math.random() * N);
      if (a !== b) { adj[a].push(b); adj[b].push(a); }
    }
  } else {
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const i = r * cols + c;
        if (c + 1 < cols) { adj[i].push(i + 1); adj[i + 1].push(i); }
        if (r + 1 < rows) { adj[i].push(i + cols); adj[i + cols].push(i); }
      }
    }
  }

  const state = Array(N).fill(true);
  const startDefector = type === 'hub' ? 0 : Math.floor(N / 2);
  state[startDefector] = false;

  const rects = svg.selectAll('rect').data(d3.range(N)).enter().append('rect')
    .attr('x', (d) => ox + (d % cols) * cw + 2)
    .attr('y', (d) => oy + Math.floor(d / cols) * ch + 2)
    .attr('width', cw - 4).attr('height', ch - 4)
    .attr('rx', 4)
    .attr('fill', d => state[d] ? '#3b82f6' : '#ef4444');

  let step = 0;
  const maxSteps = 20;

  function tick() {
    if (step >= maxSteps) {
      const defCount = state.filter(s => !s).length;
      d3.select('#spread-stat').html(`After ${step} steps: <strong>${defCount}/${N}</strong> nodes defecting (${Math.round(defCount/N*100)}%)`);
      return;
    }
    step++;
    const newState = [...state];
    for (let i = 0; i < N; i++) {
      if (state[i]) {
        const defNeighbors = adj[i].filter(j => !state[j]).length;
        const totalNeighbors = adj[i].length || 1;
        if (defNeighbors / totalNeighbors > 0.3 + Math.random() * 0.2) {
          newState[i] = false;
        }
      }
    }
    for (let i = 0; i < N; i++) state[i] = newState[i];
    rects.transition().duration(200)
      .attr('fill', d => state[d] ? '#3b82f6' : '#ef4444');

    const defCount = state.filter(s => !s).length;
    d3.select('#spread-stat').html(`Step ${step}: <strong>${defCount}/${N}</strong> defecting`);
    setTimeout(tick, 350);
  }
  tick();
}
</script>
</body>
</html>
